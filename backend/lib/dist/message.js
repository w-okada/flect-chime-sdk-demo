"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.authorize = void 0;
const aws_sdk_1 = require("aws-sdk");
const chime = new aws_sdk_1.Chime({ region: "us-east-1" });
const ddb = new aws_sdk_1.DynamoDB();
/**
 * generate policy. subfunction of authorizer.
 * @param {*} principalId
 * @param {*} effect
 * @param {*} resource
 * @param {*} context
 */
const generatePolicy = (principalId, effect, resource, context) => {
    if (effect && resource) {
        const policyDocument = {
            Version: "2012-10-17",
            Statement: [
                {
                    Action: "execute-api:Invoke",
                    Effect: effect,
                    Resource: resource,
                },
            ],
        };
        const authResponse = {
            principalId: principalId,
            policyDocument: policyDocument,
            context: context,
        };
        return authResponse;
    }
    return {};
};
/**
 * Authorizer
 * (1) check query parameter. meetingId, attendeeId, joinToken
 * (2) check attendee in the meeting
 * (3) check joinToken
 * (4) return policy
 * @param {*} event
 * @param {*} context
 * @param {*} callback
 */
const authorize = async (event, context, callback) => {
    console.log("authorize event:", JSON.stringify(event, null, 2));
    console.log("authorize event:", JSON.stringify(context, null, 2));
    let passedAuthCheck = false;
    //// (1) check query parameter. meetingId, attendeeId, joinToken
    if (!event.queryStringParameters.meetingId || !event.queryStringParameters.attendeeId || !event.queryStringParameters.joinToken) {
        console.error("missing MeetingId, AttendeeId, JoinToken parameters", event.queryStringParameters);
        return generatePolicy("me", "Deny", event.methodArn, {});
    }
    console.log("meetingId:", event.queryStringParameters.meetingId);
    console.log("attendeeId:", event.queryStringParameters.attendeeId);
    console.log("joinToken:", event.queryStringParameters.joinToken);
    //// (2) check attendee in the meeting
    let attendeeInfo;
    try {
        console.log("auth attendeeId1: ", event.queryStringParameters.attendeeId);
        const attendeeId = event.queryStringParameters.attendeeId.split("_")[0]; //// for extension, (currently no meeting)
        console.log("auth attendeeId2: ", attendeeId);
        attendeeInfo = await chime
            .getAttendee({
            MeetingId: event.queryStringParameters.meetingId,
            AttendeeId: attendeeId,
        })
            .promise();
    }
    catch (e) {
        console.error(`failed to authenticate with join token: ${e}`);
        return generatePolicy("me", "Deny", event.methodArn, {});
    }
    //// (3) check joinToken
    if (attendeeInfo.Attendee.JoinToken !== event.queryStringParameters.joinToken) {
        console.error(`failed to authenticate with join token ${attendeeInfo.Attendee.JoinToken} - ${event.queryStringParameters.joinToken}`);
        return generatePolicy("me", "Deny", event.methodArn, {});
    }
    //// (4) return policy
    return generatePolicy("me", "Allow", event.methodArn, {
        meetingId: event.queryStringParameters.meetingId,
        attendeeId: event.queryStringParameters.attendeeId,
    });
};
exports.authorize = authorize;
/**
 * register connection. The connectionId is generatedBy API GW automatically?
 * (1) register connection info to DB
 * @param {*} event
 * @param {*} context
 * @param {*} callback
 */
exports.connect = async (event, context, callback) => {
    console.log(event);
    console.log(context);
    console.log(callback);
    //// (1) register connection info to DB
    const oneDayFromNow = Math.floor(Date.now() / 1000) + 60 * 60 * 24;
    try {
        const meetingId = event.queryStringParameters.meetingId;
        const attendeeId = event.queryStringParameters.attendeeId;
        console.log("meetingId:", meetingId);
        console.log("attendeeId", attendeeId);
        const res = await ddb
            .putItem({
            TableName: process.env.CONNECTION_TABLE_NAME,
            Item: {
                MeetingId: { S: meetingId },
                AttendeeId: { S: attendeeId },
                ConnectionId: { S: event.requestContext.connectionId },
                TTL: { N: `${oneDayFromNow}` },
            },
        })
            .promise();
        console.log("update res", res);
    }
    catch (e) {
        console.error(`error connecting: ${e}`);
        return {
            statusCode: 500,
            body: `Failed to connect: ${JSON.stringify(e)}`,
        };
    }
    return { statusCode: 200, body: "Connected." };
};
/**
 * disconnect.
 * (1) remove connection from DB
 * @param {*} event
 * @param {*} context
 * @param {*} callback
 */
exports.disconnect = async (event, context, callback) => {
    console.log(event);
    console.log(context);
    console.log(callback);
    try {
        const meetingId = event.requestContext.authorizer.meetingId;
        const attendeeId = event.requestContext.authorizer.attendeeId;
        console.log(meetingId, attendeeId);
        //// (1) remove connection from DB
        await ddb
            .deleteItem({
            TableName: process.env.CONNECTION_TABLE_NAME,
            Key: {
                MeetingId: { S: meetingId },
                AttendeeId: { S: attendeeId },
            },
        })
            .promise();
    }
    catch (err) {
        console.error(`error : ${err}`);
        return {
            statusCode: 500,
            body: `Failed to disconnect: ${JSON.stringify(err)}`,
        };
    }
    return { statusCode: 200, body: "Disconnected." };
};
/**
 * message
 * (1) Gather the information of attendees in the same meeting
 * (2) get endpoint of API GW
 * (3) decide the destination
 * (4) send message
 * @param {*} event
 * @param {*} context
 * @param {*} callback
 */
exports.message = async (event, context, callback) => {
    console.log(event);
    console.log(context);
    console.log(callback);
    console.log("sendmessage event:", JSON.stringify(event, null, 2));
    console.log("meetingId", event.requestContext.authorizer.meetingId);
    //// (1) Gather the information of attendees in the same meeting
    let attendees;
    try {
        attendees = await ddb
            .query({
            ExpressionAttributeValues: {
                ":meetingId": { S: event.requestContext.authorizer.meetingId },
            },
            KeyConditionExpression: "MeetingId = :meetingId",
            ProjectionExpression: "ConnectionId, AttendeeId",
            TableName: process.env.CONNECTION_TABLE_NAME,
        })
            .promise();
    }
    catch (e) {
        console.log("Query error:", e);
        return { statusCode: 500, body: JSON.stringify(e) };
    }
    //// (2) get endpoint of API GW
    const apigwManagementApi = new aws_sdk_1.ApiGatewayManagementApi({
        apiVersion: "2018-11-29",
        endpoint: `${event.requestContext.domainName}/${event.requestContext.stage}`,
    });
    //// (3) decide the destination
    console.log("DATA:", event.body);
    console.log("Attendee!!!:", attendees);
    const body = JSON.parse(event.body);
    const targetId = body.targetId;
    const privateMessage = body.private;
    console.log("targetId:", targetId);
    console.log("private:", privateMessage);
    /// (4) send message
    const postCalls = attendees.Items.map(async (connection) => {
        const connectionId = connection.ConnectionId.S;
        const attendeeId = connection.AttendeeId.S;
        if (privateMessage !== true || attendeeId === targetId) {
            try {
                const res = await apigwManagementApi
                    .postToConnection({
                    ConnectionId: connectionId,
                    Data: JSON.stringify(body),
                })
                    .promise();
                console.log("done sending!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1", res);
                console.log("done sending!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!2", connectionId);
                console.log("done sending!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!3", JSON.stringify(body));
            }
            catch (e) {
                console.error(`error posting to connection ${connectionId}: ${JSON.stringify(e)}`);
            }
        }
    });
    try {
        const res = await Promise.all(postCalls);
        console.log("RESPONSE!", res);
    }
    catch (e) {
        console.error(`failed to post: ${JSON.stringify(e)}`);
        return { statusCode: 500, body: JSON.stringify(e) };
    }
    body.done = true;
    // body.content.fileParts = "" // reduce trafic
    return { statusCode: 200, body: JSON.stringify(body) };
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xhbWJkYTIvbWVzc2FnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBbUU7QUFFbkUsTUFBTSxLQUFLLEdBQUcsSUFBSSxlQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUNqRCxNQUFNLEdBQUcsR0FBRyxJQUFJLGtCQUFRLEVBQUUsQ0FBQztBQUUzQjs7Ozs7O0dBTUc7QUFDSCxNQUFNLGNBQWMsR0FBRyxDQUFDLFdBQW1CLEVBQUUsTUFBYyxFQUFFLFFBQWdCLEVBQUUsT0FBWSxFQUFFLEVBQUU7SUFDM0YsSUFBSSxNQUFNLElBQUksUUFBUSxFQUFFO1FBQ3BCLE1BQU0sY0FBYyxHQUFHO1lBQ25CLE9BQU8sRUFBRSxZQUFZO1lBQ3JCLFNBQVMsRUFBRTtnQkFDUDtvQkFDSSxNQUFNLEVBQUUsb0JBQW9CO29CQUM1QixNQUFNLEVBQUUsTUFBTTtvQkFDZCxRQUFRLEVBQUUsUUFBUTtpQkFDckI7YUFDSjtTQUNKLENBQUM7UUFDRixNQUFNLFlBQVksR0FBRztZQUNqQixXQUFXLEVBQUUsV0FBVztZQUN4QixjQUFjLEVBQUUsY0FBYztZQUM5QixPQUFPLEVBQUUsT0FBTztTQUNuQixDQUFDO1FBQ0YsT0FBTyxZQUFZLENBQUM7S0FDdkI7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUMsQ0FBQztBQUVGOzs7Ozs7Ozs7R0FTRztBQUNJLE1BQU0sU0FBUyxHQUFHLEtBQUssRUFBRSxLQUFVLEVBQUUsT0FBWSxFQUFFLFFBQWEsRUFBRSxFQUFFO0lBQ3ZFLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDaEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRSxJQUFJLGVBQWUsR0FBRyxLQUFLLENBQUM7SUFFNUIsZ0VBQWdFO0lBQ2hFLElBQUksQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsU0FBUyxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsSUFBSSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLEVBQUU7UUFDN0gsT0FBTyxDQUFDLEtBQUssQ0FBQyxxREFBcUQsRUFBRSxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUNsRyxPQUFPLGNBQWMsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDNUQ7SUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMscUJBQXFCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDakUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ25FLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUVqRSxzQ0FBc0M7SUFDdEMsSUFBSSxZQUFZLENBQUM7SUFDakIsSUFBSTtRQUNBLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzFFLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsMENBQTBDO1FBQ25ILE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDOUMsWUFBWSxHQUFHLE1BQU0sS0FBSzthQUNyQixXQUFXLENBQUM7WUFDVCxTQUFTLEVBQUUsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFNBQVM7WUFDaEQsVUFBVSxFQUFFLFVBQVU7U0FDekIsQ0FBQzthQUNELE9BQU8sRUFBRSxDQUFDO0tBQ2xCO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsS0FBSyxDQUFDLDJDQUEyQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzlELE9BQU8sY0FBYyxDQUFDLElBQUksRUFBRSxNQUFNLEVBQUUsS0FBSyxDQUFDLFNBQVMsRUFBRSxFQUFFLENBQUMsQ0FBQztLQUM1RDtJQUVELHdCQUF3QjtJQUN4QixJQUFJLFlBQVksQ0FBQyxRQUFTLENBQUMsU0FBUyxLQUFLLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLEVBQUU7UUFDNUUsT0FBTyxDQUFDLEtBQUssQ0FBQywwQ0FBMEMsWUFBWSxDQUFDLFFBQVMsQ0FBQyxTQUFTLE1BQU0sS0FBSyxDQUFDLHFCQUFxQixDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUM7UUFDdkksT0FBTyxjQUFjLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQzVEO0lBRUQsc0JBQXNCO0lBQ3RCLE9BQU8sY0FBYyxDQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLFNBQVMsRUFBRTtRQUNsRCxTQUFTLEVBQUUsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFNBQVM7UUFDaEQsVUFBVSxFQUFFLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxVQUFVO0tBQ3JELENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQTNDVyxRQUFBLFNBQVMsYUEyQ3BCO0FBRUY7Ozs7OztHQU1HO0FBQ0gsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBVSxFQUFFLE9BQVksRUFBRSxRQUFhLEVBQUUsRUFBRTtJQUNoRSxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0Qix1Q0FBdUM7SUFDdkMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7SUFDbkUsSUFBSTtRQUNBLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUM7UUFDeEQsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixDQUFDLFVBQVUsQ0FBQztRQUMxRCxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNyQyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN0QyxNQUFNLEdBQUcsR0FBRyxNQUFNLEdBQUc7YUFDaEIsT0FBTyxDQUFDO1lBQ0wsU0FBUyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXNCO1lBQzdDLElBQUksRUFBRTtnQkFDRixTQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsU0FBUyxFQUFFO2dCQUMzQixVQUFVLEVBQUUsRUFBRSxDQUFDLEVBQUUsVUFBVSxFQUFFO2dCQUM3QixZQUFZLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxZQUFZLEVBQUU7Z0JBQ3RELEdBQUcsRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLGFBQWEsRUFBRSxFQUFFO2FBQ2pDO1NBQ0osQ0FBQzthQUNELE9BQU8sRUFBRSxDQUFDO1FBRWYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUUsR0FBRyxDQUFDLENBQUM7S0FDbEM7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLE9BQU8sQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDeEMsT0FBTztZQUNILFVBQVUsRUFBRSxHQUFHO1lBQ2YsSUFBSSxFQUFFLHNCQUFzQixJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFO1NBQ2xELENBQUM7S0FDTDtJQUNELE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsQ0FBQztBQUNuRCxDQUFDLENBQUM7QUFFRjs7Ozs7O0dBTUc7QUFDSCxPQUFPLENBQUMsVUFBVSxHQUFHLEtBQUssRUFBRSxLQUFVLEVBQUUsT0FBWSxFQUFFLFFBQWEsRUFBRSxFQUFFO0lBQ25FLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbkIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNyQixPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3RCLElBQUk7UUFDQSxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUM7UUFDNUQsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDO1FBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ25DLGtDQUFrQztRQUNsQyxNQUFNLEdBQUc7YUFDSixVQUFVLENBQUM7WUFDUixTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBc0I7WUFDN0MsR0FBRyxFQUFFO2dCQUNELFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxTQUFTLEVBQUU7Z0JBQzNCLFVBQVUsRUFBRSxFQUFFLENBQUMsRUFBRSxVQUFVLEVBQUU7YUFDaEM7U0FDSixDQUFDO2FBQ0QsT0FBTyxFQUFFLENBQUM7S0FDbEI7SUFBQyxPQUFPLEdBQUcsRUFBRTtRQUNWLE9BQU8sQ0FBQyxLQUFLLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ2hDLE9BQU87WUFDSCxVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSx5QkFBeUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRTtTQUN2RCxDQUFDO0tBQ0w7SUFDRCxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLENBQUM7QUFDdEQsQ0FBQyxDQUFDO0FBRUY7Ozs7Ozs7OztHQVNHO0FBQ0gsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBVSxFQUFFLE9BQVksRUFBRSxRQUFhLEVBQUUsRUFBRTtJQUNoRSxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2xFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3BFLGdFQUFnRTtJQUNoRSxJQUFJLFNBQVMsQ0FBQztJQUNkLElBQUk7UUFDQSxTQUFTLEdBQUcsTUFBTSxHQUFHO2FBQ2hCLEtBQUssQ0FBQztZQUNILHlCQUF5QixFQUFFO2dCQUN2QixZQUFZLEVBQUUsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFFO2FBQ2pFO1lBQ0Qsc0JBQXNCLEVBQUUsd0JBQXdCO1lBQ2hELG9CQUFvQixFQUFFLDBCQUEwQjtZQUNoRCxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBc0I7U0FDaEQsQ0FBQzthQUNELE9BQU8sRUFBRSxDQUFDO0tBQ2xCO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMvQixPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0tBQ3ZEO0lBRUQsK0JBQStCO0lBQy9CLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxpQ0FBdUIsQ0FBQztRQUNuRCxVQUFVLEVBQUUsWUFBWTtRQUN4QixRQUFRLEVBQUUsR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLFVBQVUsSUFBSSxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRTtLQUMvRSxDQUFDLENBQUM7SUFFSCwrQkFBK0I7SUFDL0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3BDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDL0IsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztJQUVwQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUV4QyxvQkFBb0I7SUFDcEIsTUFBTSxTQUFTLEdBQUcsU0FBUyxDQUFDLEtBQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLFVBQWUsRUFBRSxFQUFFO1FBQzdELE1BQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBQy9DLE1BQU0sVUFBVSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQzNDLElBQUksY0FBYyxLQUFLLElBQUksSUFBSSxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ3BELElBQUk7Z0JBQ0EsTUFBTSxHQUFHLEdBQUcsTUFBTSxrQkFBa0I7cUJBQy9CLGdCQUFnQixDQUFDO29CQUNkLFlBQVksRUFBRSxZQUFZO29CQUMxQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7aUJBQzdCLENBQUM7cUJBQ0QsT0FBTyxFQUFFLENBQUM7Z0JBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQ0FBK0MsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFDbEUsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQ0FBK0MsRUFBRSxZQUFZLENBQUMsQ0FBQztnQkFDM0UsT0FBTyxDQUFDLEdBQUcsQ0FBQywrQ0FBK0MsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDdEY7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFDUixPQUFPLENBQUMsS0FBSyxDQUFDLCtCQUErQixZQUFZLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDdEY7U0FDSjtJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSTtRQUNBLE1BQU0sR0FBRyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQztLQUNqQztJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztLQUN2RDtJQUVELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ2pCLCtDQUErQztJQUUvQyxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO0FBQzNELENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoaW1lLCBEeW5hbW9EQiwgQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkgfSBmcm9tIFwiYXdzLXNka1wiO1xuXG5jb25zdCBjaGltZSA9IG5ldyBDaGltZSh7IHJlZ2lvbjogXCJ1cy1lYXN0LTFcIiB9KTtcbmNvbnN0IGRkYiA9IG5ldyBEeW5hbW9EQigpO1xuXG4vKipcbiAqIGdlbmVyYXRlIHBvbGljeS4gc3ViZnVuY3Rpb24gb2YgYXV0aG9yaXplci5cbiAqIEBwYXJhbSB7Kn0gcHJpbmNpcGFsSWRcbiAqIEBwYXJhbSB7Kn0gZWZmZWN0XG4gKiBAcGFyYW0geyp9IHJlc291cmNlXG4gKiBAcGFyYW0geyp9IGNvbnRleHRcbiAqL1xuY29uc3QgZ2VuZXJhdGVQb2xpY3kgPSAocHJpbmNpcGFsSWQ6IHN0cmluZywgZWZmZWN0OiBzdHJpbmcsIHJlc291cmNlOiBzdHJpbmcsIGNvbnRleHQ6IGFueSkgPT4ge1xuICAgIGlmIChlZmZlY3QgJiYgcmVzb3VyY2UpIHtcbiAgICAgICAgY29uc3QgcG9saWN5RG9jdW1lbnQgPSB7XG4gICAgICAgICAgICBWZXJzaW9uOiBcIjIwMTItMTAtMTdcIixcbiAgICAgICAgICAgIFN0YXRlbWVudDogW1xuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgQWN0aW9uOiBcImV4ZWN1dGUtYXBpOkludm9rZVwiLFxuICAgICAgICAgICAgICAgICAgICBFZmZlY3Q6IGVmZmVjdCxcbiAgICAgICAgICAgICAgICAgICAgUmVzb3VyY2U6IHJlc291cmNlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBdLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBhdXRoUmVzcG9uc2UgPSB7XG4gICAgICAgICAgICBwcmluY2lwYWxJZDogcHJpbmNpcGFsSWQsXG4gICAgICAgICAgICBwb2xpY3lEb2N1bWVudDogcG9saWN5RG9jdW1lbnQsXG4gICAgICAgICAgICBjb250ZXh0OiBjb250ZXh0LFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gYXV0aFJlc3BvbnNlO1xuICAgIH1cbiAgICByZXR1cm4ge307XG59O1xuXG4vKipcbiAqIEF1dGhvcml6ZXJcbiAqICgxKSBjaGVjayBxdWVyeSBwYXJhbWV0ZXIuIG1lZXRpbmdJZCwgYXR0ZW5kZWVJZCwgam9pblRva2VuXG4gKiAoMikgY2hlY2sgYXR0ZW5kZWUgaW4gdGhlIG1lZXRpbmdcbiAqICgzKSBjaGVjayBqb2luVG9rZW5cbiAqICg0KSByZXR1cm4gcG9saWN5XG4gKiBAcGFyYW0geyp9IGV2ZW50XG4gKiBAcGFyYW0geyp9IGNvbnRleHRcbiAqIEBwYXJhbSB7Kn0gY2FsbGJhY2tcbiAqL1xuZXhwb3J0IGNvbnN0IGF1dGhvcml6ZSA9IGFzeW5jIChldmVudDogYW55LCBjb250ZXh0OiBhbnksIGNhbGxiYWNrOiBhbnkpID0+IHtcbiAgICBjb25zb2xlLmxvZyhcImF1dGhvcml6ZSBldmVudDpcIiwgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcbiAgICBjb25zb2xlLmxvZyhcImF1dGhvcml6ZSBldmVudDpcIiwgSlNPTi5zdHJpbmdpZnkoY29udGV4dCwgbnVsbCwgMikpO1xuICAgIGxldCBwYXNzZWRBdXRoQ2hlY2sgPSBmYWxzZTtcblxuICAgIC8vLy8gKDEpIGNoZWNrIHF1ZXJ5IHBhcmFtZXRlci4gbWVldGluZ0lkLCBhdHRlbmRlZUlkLCBqb2luVG9rZW5cbiAgICBpZiAoIWV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycy5tZWV0aW5nSWQgfHwgIWV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycy5hdHRlbmRlZUlkIHx8ICFldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMuam9pblRva2VuKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJtaXNzaW5nIE1lZXRpbmdJZCwgQXR0ZW5kZWVJZCwgSm9pblRva2VuIHBhcmFtZXRlcnNcIiwgZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzKTtcbiAgICAgICAgcmV0dXJuIGdlbmVyYXRlUG9saWN5KFwibWVcIiwgXCJEZW55XCIsIGV2ZW50Lm1ldGhvZEFybiwge30pO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKFwibWVldGluZ0lkOlwiLCBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMubWVldGluZ0lkKTtcbiAgICBjb25zb2xlLmxvZyhcImF0dGVuZGVlSWQ6XCIsIGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycy5hdHRlbmRlZUlkKTtcbiAgICBjb25zb2xlLmxvZyhcImpvaW5Ub2tlbjpcIiwgZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLmpvaW5Ub2tlbik7XG5cbiAgICAvLy8vICgyKSBjaGVjayBhdHRlbmRlZSBpbiB0aGUgbWVldGluZ1xuICAgIGxldCBhdHRlbmRlZUluZm87XG4gICAgdHJ5IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJhdXRoIGF0dGVuZGVlSWQxOiBcIiwgZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLmF0dGVuZGVlSWQpO1xuICAgICAgICBjb25zdCBhdHRlbmRlZUlkID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLmF0dGVuZGVlSWQuc3BsaXQoXCJfXCIpWzBdOyAvLy8vIGZvciBleHRlbnNpb24sIChjdXJyZW50bHkgbm8gbWVldGluZylcbiAgICAgICAgY29uc29sZS5sb2coXCJhdXRoIGF0dGVuZGVlSWQyOiBcIiwgYXR0ZW5kZWVJZCk7XG4gICAgICAgIGF0dGVuZGVlSW5mbyA9IGF3YWl0IGNoaW1lXG4gICAgICAgICAgICAuZ2V0QXR0ZW5kZWUoe1xuICAgICAgICAgICAgICAgIE1lZXRpbmdJZDogZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLm1lZXRpbmdJZCxcbiAgICAgICAgICAgICAgICBBdHRlbmRlZUlkOiBhdHRlbmRlZUlkLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5wcm9taXNlKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBmYWlsZWQgdG8gYXV0aGVudGljYXRlIHdpdGggam9pbiB0b2tlbjogJHtlfWApO1xuICAgICAgICByZXR1cm4gZ2VuZXJhdGVQb2xpY3koXCJtZVwiLCBcIkRlbnlcIiwgZXZlbnQubWV0aG9kQXJuLCB7fSk7XG4gICAgfVxuXG4gICAgLy8vLyAoMykgY2hlY2sgam9pblRva2VuXG4gICAgaWYgKGF0dGVuZGVlSW5mby5BdHRlbmRlZSEuSm9pblRva2VuICE9PSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMuam9pblRva2VuKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYGZhaWxlZCB0byBhdXRoZW50aWNhdGUgd2l0aCBqb2luIHRva2VuICR7YXR0ZW5kZWVJbmZvLkF0dGVuZGVlIS5Kb2luVG9rZW59IC0gJHtldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMuam9pblRva2VufWApO1xuICAgICAgICByZXR1cm4gZ2VuZXJhdGVQb2xpY3koXCJtZVwiLCBcIkRlbnlcIiwgZXZlbnQubWV0aG9kQXJuLCB7fSk7XG4gICAgfVxuXG4gICAgLy8vLyAoNCkgcmV0dXJuIHBvbGljeVxuICAgIHJldHVybiBnZW5lcmF0ZVBvbGljeShcIm1lXCIsIFwiQWxsb3dcIiwgZXZlbnQubWV0aG9kQXJuLCB7XG4gICAgICAgIG1lZXRpbmdJZDogZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLm1lZXRpbmdJZCxcbiAgICAgICAgYXR0ZW5kZWVJZDogZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLmF0dGVuZGVlSWQsXG4gICAgfSk7XG59O1xuXG4vKipcbiAqIHJlZ2lzdGVyIGNvbm5lY3Rpb24uIFRoZSBjb25uZWN0aW9uSWQgaXMgZ2VuZXJhdGVkQnkgQVBJIEdXIGF1dG9tYXRpY2FsbHk/XG4gKiAoMSkgcmVnaXN0ZXIgY29ubmVjdGlvbiBpbmZvIHRvIERCXG4gKiBAcGFyYW0geyp9IGV2ZW50XG4gKiBAcGFyYW0geyp9IGNvbnRleHRcbiAqIEBwYXJhbSB7Kn0gY2FsbGJhY2tcbiAqL1xuZXhwb3J0cy5jb25uZWN0ID0gYXN5bmMgKGV2ZW50OiBhbnksIGNvbnRleHQ6IGFueSwgY2FsbGJhY2s6IGFueSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKGV2ZW50KTtcbiAgICBjb25zb2xlLmxvZyhjb250ZXh0KTtcbiAgICBjb25zb2xlLmxvZyhjYWxsYmFjayk7XG4gICAgLy8vLyAoMSkgcmVnaXN0ZXIgY29ubmVjdGlvbiBpbmZvIHRvIERCXG4gICAgY29uc3Qgb25lRGF5RnJvbU5vdyA9IE1hdGguZmxvb3IoRGF0ZS5ub3coKSAvIDEwMDApICsgNjAgKiA2MCAqIDI0O1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IG1lZXRpbmdJZCA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycy5tZWV0aW5nSWQ7XG4gICAgICAgIGNvbnN0IGF0dGVuZGVlSWQgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMuYXR0ZW5kZWVJZDtcbiAgICAgICAgY29uc29sZS5sb2coXCJtZWV0aW5nSWQ6XCIsIG1lZXRpbmdJZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiYXR0ZW5kZWVJZFwiLCBhdHRlbmRlZUlkKTtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgZGRiXG4gICAgICAgICAgICAucHV0SXRlbSh7XG4gICAgICAgICAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5DT05ORUNUSU9OX1RBQkxFX05BTUUhLFxuICAgICAgICAgICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgICAgICAgICAgTWVldGluZ0lkOiB7IFM6IG1lZXRpbmdJZCB9LFxuICAgICAgICAgICAgICAgICAgICBBdHRlbmRlZUlkOiB7IFM6IGF0dGVuZGVlSWQgfSxcbiAgICAgICAgICAgICAgICAgICAgQ29ubmVjdGlvbklkOiB7IFM6IGV2ZW50LnJlcXVlc3RDb250ZXh0LmNvbm5lY3Rpb25JZCB9LCAvLyBhdXRvIGdlbmVyYXRlZCBieSBBUEkgR1dcbiAgICAgICAgICAgICAgICAgICAgVFRMOiB7IE46IGAke29uZURheUZyb21Ob3d9YCB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnByb21pc2UoKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhcInVwZGF0ZSByZXNcIiwgcmVzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIGNvbm5lY3Rpbmc6ICR7ZX1gKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgICAgICAgIGJvZHk6IGBGYWlsZWQgdG8gY29ubmVjdDogJHtKU09OLnN0cmluZ2lmeShlKX1gLFxuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IFwiQ29ubmVjdGVkLlwiIH07XG59O1xuXG4vKipcbiAqIGRpc2Nvbm5lY3QuXG4gKiAoMSkgcmVtb3ZlIGNvbm5lY3Rpb24gZnJvbSBEQlxuICogQHBhcmFtIHsqfSBldmVudFxuICogQHBhcmFtIHsqfSBjb250ZXh0XG4gKiBAcGFyYW0geyp9IGNhbGxiYWNrXG4gKi9cbmV4cG9ydHMuZGlzY29ubmVjdCA9IGFzeW5jIChldmVudDogYW55LCBjb250ZXh0OiBhbnksIGNhbGxiYWNrOiBhbnkpID0+IHtcbiAgICBjb25zb2xlLmxvZyhldmVudCk7XG4gICAgY29uc29sZS5sb2coY29udGV4dCk7XG4gICAgY29uc29sZS5sb2coY2FsbGJhY2spO1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IG1lZXRpbmdJZCA9IGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXIubWVldGluZ0lkO1xuICAgICAgICBjb25zdCBhdHRlbmRlZUlkID0gZXZlbnQucmVxdWVzdENvbnRleHQuYXV0aG9yaXplci5hdHRlbmRlZUlkO1xuICAgICAgICBjb25zb2xlLmxvZyhtZWV0aW5nSWQsIGF0dGVuZGVlSWQpO1xuICAgICAgICAvLy8vICgxKSByZW1vdmUgY29ubmVjdGlvbiBmcm9tIERCXG4gICAgICAgIGF3YWl0IGRkYlxuICAgICAgICAgICAgLmRlbGV0ZUl0ZW0oe1xuICAgICAgICAgICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuQ09OTkVDVElPTl9UQUJMRV9OQU1FISxcbiAgICAgICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgICAgICAgTWVldGluZ0lkOiB7IFM6IG1lZXRpbmdJZCB9LFxuICAgICAgICAgICAgICAgICAgICBBdHRlbmRlZUlkOiB7IFM6IGF0dGVuZGVlSWQgfSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5wcm9taXNlKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYGVycm9yIDogJHtlcnJ9YCk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICAgICAgICBib2R5OiBgRmFpbGVkIHRvIGRpc2Nvbm5lY3Q6ICR7SlNPTi5zdHJpbmdpZnkoZXJyKX1gLFxuICAgICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IFwiRGlzY29ubmVjdGVkLlwiIH07XG59O1xuXG4vKipcbiAqIG1lc3NhZ2VcbiAqICgxKSBHYXRoZXIgdGhlIGluZm9ybWF0aW9uIG9mIGF0dGVuZGVlcyBpbiB0aGUgc2FtZSBtZWV0aW5nXG4gKiAoMikgZ2V0IGVuZHBvaW50IG9mIEFQSSBHV1xuICogKDMpIGRlY2lkZSB0aGUgZGVzdGluYXRpb25cbiAqICg0KSBzZW5kIG1lc3NhZ2VcbiAqIEBwYXJhbSB7Kn0gZXZlbnRcbiAqIEBwYXJhbSB7Kn0gY29udGV4dFxuICogQHBhcmFtIHsqfSBjYWxsYmFja1xuICovXG5leHBvcnRzLm1lc3NhZ2UgPSBhc3luYyAoZXZlbnQ6IGFueSwgY29udGV4dDogYW55LCBjYWxsYmFjazogYW55KSA9PiB7XG4gICAgY29uc29sZS5sb2coZXZlbnQpO1xuICAgIGNvbnNvbGUubG9nKGNvbnRleHQpO1xuICAgIGNvbnNvbGUubG9nKGNhbGxiYWNrKTtcbiAgICBjb25zb2xlLmxvZyhcInNlbmRtZXNzYWdlIGV2ZW50OlwiLCBKU09OLnN0cmluZ2lmeShldmVudCwgbnVsbCwgMikpO1xuICAgIGNvbnNvbGUubG9nKFwibWVldGluZ0lkXCIsIGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXIubWVldGluZ0lkKTtcbiAgICAvLy8vICgxKSBHYXRoZXIgdGhlIGluZm9ybWF0aW9uIG9mIGF0dGVuZGVlcyBpbiB0aGUgc2FtZSBtZWV0aW5nXG4gICAgbGV0IGF0dGVuZGVlcztcbiAgICB0cnkge1xuICAgICAgICBhdHRlbmRlZXMgPSBhd2FpdCBkZGJcbiAgICAgICAgICAgIC5xdWVyeSh7XG4gICAgICAgICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgICAgICAgICBcIjptZWV0aW5nSWRcIjogeyBTOiBldmVudC5yZXF1ZXN0Q29udGV4dC5hdXRob3JpemVyLm1lZXRpbmdJZCB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogXCJNZWV0aW5nSWQgPSA6bWVldGluZ0lkXCIsXG4gICAgICAgICAgICAgICAgUHJvamVjdGlvbkV4cHJlc3Npb246IFwiQ29ubmVjdGlvbklkLCBBdHRlbmRlZUlkXCIsXG4gICAgICAgICAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5DT05ORUNUSU9OX1RBQkxFX05BTUUhLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5wcm9taXNlKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIlF1ZXJ5IGVycm9yOlwiLCBlKTtcbiAgICAgICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogNTAwLCBib2R5OiBKU09OLnN0cmluZ2lmeShlKSB9O1xuICAgIH1cblxuICAgIC8vLy8gKDIpIGdldCBlbmRwb2ludCBvZiBBUEkgR1dcbiAgICBjb25zdCBhcGlnd01hbmFnZW1lbnRBcGkgPSBuZXcgQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGkoe1xuICAgICAgICBhcGlWZXJzaW9uOiBcIjIwMTgtMTEtMjlcIixcbiAgICAgICAgZW5kcG9pbnQ6IGAke2V2ZW50LnJlcXVlc3RDb250ZXh0LmRvbWFpbk5hbWV9LyR7ZXZlbnQucmVxdWVzdENvbnRleHQuc3RhZ2V9YCxcbiAgICB9KTtcblxuICAgIC8vLy8gKDMpIGRlY2lkZSB0aGUgZGVzdGluYXRpb25cbiAgICBjb25zb2xlLmxvZyhcIkRBVEE6XCIsIGV2ZW50LmJvZHkpO1xuICAgIGNvbnNvbGUubG9nKFwiQXR0ZW5kZWUhISE6XCIsIGF0dGVuZGVlcyk7XG4gICAgY29uc3QgYm9keSA9IEpTT04ucGFyc2UoZXZlbnQuYm9keSk7XG4gICAgY29uc3QgdGFyZ2V0SWQgPSBib2R5LnRhcmdldElkO1xuICAgIGNvbnN0IHByaXZhdGVNZXNzYWdlID0gYm9keS5wcml2YXRlO1xuXG4gICAgY29uc29sZS5sb2coXCJ0YXJnZXRJZDpcIiwgdGFyZ2V0SWQpO1xuICAgIGNvbnNvbGUubG9nKFwicHJpdmF0ZTpcIiwgcHJpdmF0ZU1lc3NhZ2UpO1xuXG4gICAgLy8vICg0KSBzZW5kIG1lc3NhZ2VcbiAgICBjb25zdCBwb3N0Q2FsbHMgPSBhdHRlbmRlZXMuSXRlbXMhLm1hcChhc3luYyAoY29ubmVjdGlvbjogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IGNvbm5lY3Rpb24uQ29ubmVjdGlvbklkLlM7XG4gICAgICAgIGNvbnN0IGF0dGVuZGVlSWQgPSBjb25uZWN0aW9uLkF0dGVuZGVlSWQuUztcbiAgICAgICAgaWYgKHByaXZhdGVNZXNzYWdlICE9PSB0cnVlIHx8IGF0dGVuZGVlSWQgPT09IHRhcmdldElkKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGFwaWd3TWFuYWdlbWVudEFwaVxuICAgICAgICAgICAgICAgICAgICAucG9zdFRvQ29ubmVjdGlvbih7XG4gICAgICAgICAgICAgICAgICAgICAgICBDb25uZWN0aW9uSWQ6IGNvbm5lY3Rpb25JZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGE6IEpTT04uc3RyaW5naWZ5KGJvZHkpLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAucHJvbWlzZSgpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZG9uZSBzZW5kaW5nISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISExXCIsIHJlcyk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJkb25lIHNlbmRpbmchISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhITJcIiwgY29ubmVjdGlvbklkKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImRvbmUgc2VuZGluZyEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhM1wiLCBKU09OLnN0cmluZ2lmeShib2R5KSk7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXJyb3IgcG9zdGluZyB0byBjb25uZWN0aW9uICR7Y29ubmVjdGlvbklkfTogJHtKU09OLnN0cmluZ2lmeShlKX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgUHJvbWlzZS5hbGwocG9zdENhbGxzKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJSRVNQT05TRSFcIiwgcmVzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYGZhaWxlZCB0byBwb3N0OiAke0pTT04uc3RyaW5naWZ5KGUpfWApO1xuICAgICAgICByZXR1cm4geyBzdGF0dXNDb2RlOiA1MDAsIGJvZHk6IEpTT04uc3RyaW5naWZ5KGUpIH07XG4gICAgfVxuXG4gICAgYm9keS5kb25lID0gdHJ1ZTtcbiAgICAvLyBib2R5LmNvbnRlbnQuZmlsZVBhcnRzID0gXCJcIiAvLyByZWR1Y2UgdHJhZmljXG5cbiAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGJvZHk6IEpTT04uc3RyaW5naWZ5KGJvZHkpIH07XG59O1xuIl19