"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.fetchToken = exports.deleteInstallation = exports.fetchInstallation = exports.addTeamInformation = void 0;
const aws_sdk_1 = require("aws-sdk");
const encrypter_1 = require("./encrypter");
const authEncrypter = new encrypter_1.Encrypter({
    password: process.env.APP_DB_PASSWORD || "pass",
    salt: process.env.APP_DB_SALT || "salt",
    secret: process.env.APP_DB_SECRET || "secret",
});
const database = {
    cache: {},
};
const ddb = new aws_sdk_1.DynamoDB();
const slackFederationAuthsTableName = process.env.SLACK_FEDERATION_AUTHS_TABLE_NAME || "";
const addInstllationToDB = async (installation) => {
    const info = JSON.stringify(installation);
    const teamId = installation.team.id;
    const encInfo = authEncrypter.encodeInformation(info);
    const item = {
        TeamId: { S: teamId },
        Data: { S: encInfo },
    };
    await ddb
        .putItem({
        TableName: slackFederationAuthsTableName,
        Item: item,
    })
        .promise();
};
const queryInstallationFromDB = async (teamId) => {
    try {
        console.log(`Query Installation1: ${teamId}`);
        const result = await ddb.getItem({ TableName: slackFederationAuthsTableName, Key: { TeamId: { S: teamId } } }).promise();
        console.log(`Query Installation2: ${JSON.stringify(result)}`);
        if (!result.Item) {
            console.log(`Query Installation: No record for ${teamId}`);
            return null;
        }
        const encInfo = result.Item.Data.S;
        console.log(`Query Installation: encInfo ${encInfo}`);
        const infoJson = authEncrypter.decodeInformation(encInfo);
        console.log(`Query Installation: info ${infoJson}`);
        const info = JSON.parse(infoJson || "{}");
        console.log(`Query Installation: info ${info}`);
        return info;
    }
    catch (exception) {
        console.log(`Query Installation Exception!: ${exception}`);
        return null;
    }
};
const deleteInstallationFromDB = async (teamId) => {
    await ddb
        .deleteItem({
        TableName: slackFederationAuthsTableName,
        Key: {
            TeamId: { S: teamId },
        },
    })
        .promise();
};
const addTeamInformation = async (installation) => {
    console.log("STORE INSTALATTION!!!!!!!!!!!");
    console.dir(database, { depth: 5 });
    const teamId = installation.team.id;
    const existInformation = await queryInstallationFromDB(teamId);
    if (existInformation) {
        await deleteInstallationFromDB(teamId);
    }
    await addInstllationToDB(installation);
    database.cache[teamId] = installation;
};
exports.addTeamInformation = addTeamInformation;
const fetchInstallation = async (installQuery) => {
    console.log("FETCH INSTALATTION!!!!!!!!!!!");
    const teamId = installQuery.teamId;
    if (!database.cache[teamId]) {
        database.cache[teamId] = await queryInstallationFromDB(teamId);
    }
    return database.cache[installQuery.teamId];
};
exports.fetchInstallation = fetchInstallation;
const deleteInstallation = async (installQuery) => {
    console.log("DELETE INSTALATTION!!!!!!!!!!!");
    delete database.cache[installQuery.teamId];
    return;
};
exports.deleteInstallation = deleteInstallation;
const fetchToken = async (teamId) => {
    console.log("FETCH TOKEN!!!!!!!!!!!");
    if (!database.cache[teamId]) {
        database.cache[teamId] = await queryInstallationFromDB(teamId);
    }
    if (database.cache[teamId]) {
        return database.cache[teamId].bot.token;
    }
    else {
        return null;
    }
};
exports.fetchToken = fetchToken;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xhbWJkYTIvZmVkZXJhdGlvbi9zbGFjay9hdXRoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHFDQUFtQztBQUNuQywyQ0FBd0M7QUFFeEMsTUFBTSxhQUFhLEdBQUcsSUFBSSxxQkFBUyxDQUFTO0lBQ3hDLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxNQUFNO0lBQy9DLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsSUFBSSxNQUFNO0lBQ3ZDLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxRQUFRO0NBQ2hELENBQUMsQ0FBQztBQU1ILE1BQU0sUUFBUSxHQUErQjtJQUN6QyxLQUFLLEVBQUUsRUFBRTtDQUNaLENBQUM7QUFFRixNQUFNLEdBQUcsR0FBRyxJQUFJLGtCQUFRLEVBQUUsQ0FBQztBQUMzQixNQUFNLDZCQUE2QixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUNBQWlDLElBQUksRUFBRSxDQUFDO0FBRTFGLE1BQU0sa0JBQWtCLEdBQUcsS0FBSyxFQUFtQyxZQUFnRCxFQUFFLEVBQUU7SUFDbkgsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUMxQyxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsSUFBSyxDQUFDLEVBQUUsQ0FBQztJQUNyQyxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdEQsTUFBTSxJQUFJLEdBQUc7UUFDVCxNQUFNLEVBQUUsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFO1FBQ3JCLElBQUksRUFBRSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUU7S0FDdkIsQ0FBQztJQUNGLE1BQU0sR0FBRztTQUNKLE9BQU8sQ0FBQztRQUNMLFNBQVMsRUFBRSw2QkFBNkI7UUFD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bSBcIkBzbGFjay9ib2x0XCI7XG5pbXBvcnQgeyBEeW5hbW9EQiB9IGZyb20gXCJhd3Mtc2RrXCI7XG5pbXBvcnQgeyBFbmNyeXB0ZXIgfSBmcm9tIFwiLi9lbmNyeXB0ZXJcIjtcblxuY29uc3QgYXV0aEVuY3J5cHRlciA9IG5ldyBFbmNyeXB0ZXI8c3RyaW5nPih7XG4gICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LkFQUF9EQl9QQVNTV09SRCB8fCBcInBhc3NcIixcbiAgICBzYWx0OiBwcm9jZXNzLmVudi5BUFBfREJfU0FMVCB8fCBcInNhbHRcIixcbiAgICBzZWNyZXQ6IHByb2Nlc3MuZW52LkFQUF9EQl9TRUNSRVQgfHwgXCJzZWNyZXRcIixcbn0pO1xuXG50eXBlIERhdGFiYXNlQ2FjaGU8QXV0aFZlcnNpb24gZXh0ZW5kcyBcInYxXCIgfCBcInYyXCI+ID0ge1xuICAgIGNhY2hlOiB7IFt0ZWFtSWQ6IHN0cmluZ106IEluc3RhbGxhdGlvbjxBdXRoVmVyc2lvbiwgYm9vbGVhbj4gfTtcbn07XG5cbmNvbnN0IGRhdGFiYXNlOiBEYXRhYmFzZUNhY2hlPFwidjFcIiB8IFwidjJcIj4gPSB7XG4gICAgY2FjaGU6IHt9LFxufTtcblxuY29uc3QgZGRiID0gbmV3IER5bmFtb0RCKCk7XG5jb25zdCBzbGFja0ZlZGVyYXRpb25BdXRoc1RhYmxlTmFtZSA9IHByb2Nlc3MuZW52LlNMQUNLX0ZFREVSQVRJT05fQVVUSFNfVEFCTEVfTkFNRSB8fCBcIlwiO1xuXG5jb25zdCBhZGRJbnN0bGxhdGlvblRvREIgPSBhc3luYyA8QXV0aFZlcnNpb24gZXh0ZW5kcyBcInYxXCIgfCBcInYyXCI+KGluc3RhbGxhdGlvbjogSW5zdGFsbGF0aW9uPEF1dGhWZXJzaW9uLCBib29sZWFuPikgPT4ge1xuICAgIGNvbnN0IGluZm8gPSBKU09OLnN0cmluZ2lmeShpbnN0YWxsYXRpb24pO1xuICAgIGNvbnN0IHRlYW1JZCA9IGluc3RhbGxhdGlvbi50ZWFtIS5pZDtcbiAgICBjb25zdCBlbmNJbmZvID0gYXV0aEVuY3J5cHRlci5lbmNvZGVJbmZvcm1hdGlvbihpbmZvKTtcbiAgICBjb25zdCBpdGVtID0ge1xuICAgICAgICBUZWFtSWQ6IHsgUzogdGVhbUlkIH0sXG4gICAgICAgIERhdGE6IHsgUzogZW5jSW5mbyB9LFxuICAgIH07XG4gICAgYXdhaXQgZGRiXG4gICAgICAgIC5wdXRJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogc2xhY2tGZWRlcmF0aW9uQXV0aHNUYWJsZU5hbWUsXG4gICAgICAgICAgICBJdGVtOiBpdGVtLFxuICAgICAgICB9KVxuICAgICAgICAucHJvbWlzZSgpO1xufTtcblxuY29uc3QgcXVlcnlJbnN0YWxsYXRpb25Gcm9tREIgPSBhc3luYyAodGVhbUlkOiBzdHJpbmcpID0+IHtcbiAgICB0cnkge1xuICAgICAgICBjb25zb2xlLmxvZyhgUXVlcnkgSW5zdGFsbGF0aW9uMTogJHt0ZWFtSWR9YCk7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRkYi5nZXRJdGVtKHsgVGFibGVOYW1lOiBzbGFja0ZlZGVyYXRpb25BdXRoc1RhYmxlTmFtZSwgS2V5OiB7IFRlYW1JZDogeyBTOiB0ZWFtSWQgfSB9IH0pLnByb21pc2UoKTtcbiAgICAgICAgY29uc29sZS5sb2coYFF1ZXJ5IEluc3RhbGxhdGlvbjI6ICR7SlNPTi5zdHJpbmdpZnkocmVzdWx0KX1gKTtcbiAgICAgICAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYFF1ZXJ5IEluc3RhbGxhdGlvbjogTm8gcmVjb3JkIGZvciAke3RlYW1JZH1gKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGVuY0luZm8gPSByZXN1bHQuSXRlbS5EYXRhLlMhO1xuICAgICAgICBjb25zb2xlLmxvZyhgUXVlcnkgSW5zdGFsbGF0aW9uOiBlbmNJbmZvICR7ZW5jSW5mb31gKTtcbiAgICAgICAgY29uc3QgaW5mb0pzb24gPSBhdXRoRW5jcnlwdGVyLmRlY29kZUluZm9ybWF0aW9uKGVuY0luZm8pO1xuICAgICAgICBjb25zb2xlLmxvZyhgUXVlcnkgSW5zdGFsbGF0aW9uOiBpbmZvICR7aW5mb0pzb259YCk7XG4gICAgICAgIGNvbnN0IGluZm8gPSBKU09OLnBhcnNlKGluZm9Kc29uIHx8IFwie31cIik7XG4gICAgICAgIGNvbnNvbGUubG9nKGBRdWVyeSBJbnN0YWxsYXRpb246IGluZm8gJHtpbmZvfWApO1xuICAgICAgICByZXR1cm4gaW5mbztcbiAgICB9IGNhdGNoIChleGNlcHRpb24pIHtcbiAgICAgICAgY29uc29sZS5sb2coYFF1ZXJ5IEluc3RhbGxhdGlvbiBFeGNlcHRpb24hOiAke2V4Y2VwdGlvbn1gKTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxufTtcblxuY29uc3QgZGVsZXRlSW5zdGFsbGF0aW9uRnJvbURCID0gYXN5bmMgKHRlYW1JZDogc3RyaW5nKSA9PiB7XG4gICAgYXdhaXQgZGRiXG4gICAgICAgIC5kZWxldGVJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogc2xhY2tGZWRlcmF0aW9uQXV0aHNUYWJsZU5hbWUsXG4gICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgICBUZWFtSWQ6IHsgUzogdGVhbUlkIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgICAgICAucHJvbWlzZSgpO1xufTtcblxuZXhwb3J0IGNvbnN0IGFkZFRlYW1JbmZvcm1hdGlvbiA9IGFzeW5jIDxBdXRoVmVyc2lvbiBleHRlbmRzIFwidjFcIiB8IFwidjJcIj4oaW5zdGFsbGF0aW9uOiBJbnN0YWxsYXRpb248QXV0aFZlcnNpb24sIGJvb2xlYW4+KSA9PiB7XG4gICAgY29uc29sZS5sb2coXCJTVE9SRSBJTlNUQUxBVFRJT04hISEhISEhISEhIVwiKTtcbiAgICBjb25zb2xlLmRpcihkYXRhYmFzZSwgeyBkZXB0aDogNSB9KTtcbiAgICBjb25zdCB0ZWFtSWQgPSBpbnN0YWxsYXRpb24udGVhbSEuaWQ7XG5cbiAgICBjb25zdCBleGlzdEluZm9ybWF0aW9uID0gYXdhaXQgcXVlcnlJbnN0YWxsYXRpb25Gcm9tREIodGVhbUlkKTtcbiAgICBpZiAoZXhpc3RJbmZvcm1hdGlvbikge1xuICAgICAgICBhd2FpdCBkZWxldGVJbnN0YWxsYXRpb25Gcm9tREIodGVhbUlkKTtcbiAgICB9XG4gICAgYXdhaXQgYWRkSW5zdGxsYXRpb25Ub0RCKGluc3RhbGxhdGlvbik7XG4gICAgZGF0YWJhc2UuY2FjaGVbdGVhbUlkXSA9IGluc3RhbGxhdGlvbjtcbn07XG5cbmV4cG9ydCBjb25zdCBmZXRjaEluc3RhbGxhdGlvbiA9IGFzeW5jIChpbnN0YWxsUXVlcnk6IEluc3RhbGxhdGlvblF1ZXJ5PGJvb2xlYW4+KSA9PiB7XG4gICAgY29uc29sZS5sb2coXCJGRVRDSCBJTlNUQUxBVFRJT04hISEhISEhISEhIVwiKTtcbiAgICBjb25zdCB0ZWFtSWQgPSBpbnN0YWxsUXVlcnkudGVhbUlkITtcbiAgICBpZiAoIWRhdGFiYXNlLmNhY2hlW3RlYW1JZF0pIHtcbiAgICAgICAgZGF0YWJhc2UuY2FjaGVbdGVhbUlkXSA9IGF3YWl0IHF1ZXJ5SW5zdGFsbGF0aW9uRnJvbURCKHRlYW1JZCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGFiYXNlLmNhY2hlW2luc3RhbGxRdWVyeS50ZWFtSWQhXTtcbn07XG5cbmV4cG9ydCBjb25zdCBkZWxldGVJbnN0YWxsYXRpb24gPSBhc3luYyAoaW5zdGFsbFF1ZXJ5OiBJbnN0YWxsYXRpb25RdWVyeTxib29sZWFuPikgPT4ge1xuICAgIGNvbnNvbGUubG9nKFwiREVMRVRFIElOU1RBTEFUVElPTiEhISEhISEhISEhXCIpO1xuICAgIGRlbGV0ZSBkYXRhYmFzZS5jYWNoZVtpbnN0YWxsUXVlcnkudGVhbUlkIV07XG4gICAgcmV0dXJuO1xufTtcblxuZXhwb3J0IGNvbnN0IGZldGNoVG9rZW4gPSBhc3luYyAodGVhbUlkOiBzdHJpbmcpID0+IHtcbiAgICBjb25zb2xlLmxvZyhcIkZFVENIIFRPS0VOISEhISEhISEhISFcIik7XG4gICAgaWYgKCFkYXRhYmFzZS5jYWNoZVt0ZWFtSWRdKSB7XG4gICAgICAgIGRhdGFiYXNlLmNhY2hlW3RlYW1JZF0gPSBhd2FpdCBxdWVyeUluc3RhbGxhdGlvbkZyb21EQih0ZWFtSWQpO1xuICAgIH1cbiAgICBpZiAoZGF0YWJhc2UuY2FjaGVbdGVhbUlkXSkge1xuICAgICAgICByZXR1cm4gZGF0YWJhc2UuY2FjaGVbdGVhbUlkXS5ib3QhLnRva2VuO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbn07XG4iXX0=