"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
const awsServerlessExpress = __importStar(require("aws-serverless-express"));
const bolt_1 = require("@slack/bolt");
const auth_1 = require("./auth");
const blocks_1 = require("./blocks");
const encrypter_1 = require("./encrypter");
const receiver = new bolt_1.ExpressReceiver({
    signingSecret: process.env.SLACK_SIGNING_SECRET || "",
    endpoints: `/slack/events`,
    clientId: process.env.SLACK_CLIENT_ID || "",
    clientSecret: process.env.SLACK_CLIENT_SECRET || "",
    stateSecret: process.env.SLACK_STATE_SECRET || "",
    scopes: ["channels:history", "chat:write", "commands", "groups:history", "users:read"],
    installationStore: {
        storeInstallation: async (installation) => {
            await (0, auth_1.addTeamInformation)(installation);
            return;
        },
        // @ts-ignore
        fetchInstallation: async (installQuery) => {
            const token = await (0, auth_1.fetchInstallation)(installQuery);
            console.log(`FETCH: ${JSON.stringify(token)}`);
            return token;
        },
        deleteInstallation: async (installQuery) => {
            await (0, auth_1.deleteInstallation)(installQuery);
            return;
        },
    },
    installerOptions: {
        directInstall: true,
    },
});
const config = {
    receiver,
    // token: process.env.SLACK_BOT_TOKEN, // for one workspace複数ワークスペースの場合はoauth installer or authorizeを使えと。
    // signingSecret: process.env.SLACK_SIGNING_SECRET,
    // logLevel: LogLevel.DEBUG,
    // processBeforeResponse: true,
};
const app = new bolt_1.App(config);
//////// (a) slash command
app.command("/chime-meeting", async ({ command, ack, say }) => {
    // await ack(); //　(★１)なぜかack後にpostができないので最後にackする。なお、ackしないとslack側でtimeoutが発生してしまう。
    const token = await (0, auth_1.fetchToken)(command.team_id);
    console.log(`GET TOKEN: ${token.substring(0, 10)}...`);
    // //// helpを入力された場合
    // if (command.text === "help") {
    //     const helpBlocks = generateHelpBlocks();
    //     app.client.chat.postEphemeral({
    //         channel: command.channel_id,
    //         blocks: helpBlocks,
    //         user: command.user_id,
    //         token: token,
    //     });
    //     return;
    // }
    /// 通常ケース
    const roomName = command.text;
    const roomInfo = {
        roomName: roomName,
        teamId: "",
        channelId: "",
        channelName: "",
        ts: "",
        attendees: [],
        ttl: 0,
    };
    const controlBlocks = (0, blocks_1.generateControlBlocks)(roomInfo);
    const msg = {
        // @ts-ignore
        channel: command.channel_id,
        // token: process.env.SLACK_BOT_TOKEN,
        token: token,
        blocks: controlBlocks,
        text: "rendering failed??",
    };
    const postResult = await app.client.chat.postMessage(msg);
    const ts = postResult.ts;
    roomInfo.ts = ts;
    ack(); // (★１)
});
//////// (b) Join button clicked.
app.action("join", async ({ client, context, body, action, ack, logger }) => {
    console.log(JSON.stringify(client.slackApiUrl));
    console.log(`JOIN Button Clicked`);
    // await ack();// (★１)
    const token = await (0, auth_1.fetchToken)(body.team.id);
    const user = await app.client.users.info({ user: body.user.id, token: token });
    // @ts-ignore
    const roomName = action.value;
    const userInfo = {
        roomName: roomName,
        teamId: body.team.id,
        channelId: body.channel.id,
        channelName: body.channel.name,
        userId: body.user.id,
        // @ts-ignore
        userName: body.user.username,
        imageUrl: user["user"]["profile"]["image_192"],
        chimeInfo: {
            // @ts-ignore
            attendeeName: body.user.username,
            useDefault: true,
        },
    };
    console.log(`User Info: ${JSON.stringify(userInfo)}`);
    if (!userInfo.roomName) {
        app.client.chat.postEphemeral({
            channel: userInfo.channelId,
            text: `ROOM[${userInfo.roomName}] not found`,
            user: userInfo.userId,
            token: token,
        });
        return;
    }
    const urlEncrypter = new encrypter_1.Encrypter({
        password: process.env.SLACK_APP_DB_PASSWORD || "pass",
        salt: process.env.SLACK_APP_DB_SALT || "salt",
        secret: process.env.SLACK_APP_DB_SECRET || "secret",
        expireSec: 60 * 60, // 60min
    });
    const encInfo = urlEncrypter.encodeInformation(userInfo);
    const CHIME_BASE_URL = process.env.DEMO_ENDPOINT;
    // const url = `${CHIME_BASE_URL}/default/index.html?slack_token=${encInfo}&restapi_endpoint_base=${BASE_URL}`;
    // TODO: REST API BASE URL
    const url = `${CHIME_BASE_URL}/default/index.html?slack_token=${encInfo}`;
    console.log(`URL::: ${url}`);
    const res = await app.client.views.open({
        // @ts-ignore
        trigger_id: body.trigger_id,
        token: token,
        view: (0, blocks_1.generateJoinModal)(userInfo, url),
    });
    if (!res.ok) {
        logger.info(`Failed to open a modal - ${JSON.stringify(res)}`);
    }
    ack(); // (★１)
    return;
});
//////// (c) Join Modal
/** show いらない？？*/
app.view("join_modal", async ({ payload, view, body, ack }) => {
    console.log("VIEW_TOP CALLED!");
    console.log("payload", JSON.stringify(payload));
    console.log("view", JSON.stringify(view));
    console.log("body", JSON.stringify(body));
    await ack({
        response_action: "update",
        view: {
            type: "modal",
            callback_id: "view_completion",
            title: {
                type: "plain_text",
                text: "My Apaasd-",
                emoji: true,
            },
            blocks: [],
        },
    });
});
/** close action */
app.view({ callback_id: "join_modal", type: "view_closed" }, async ({ ack, logger }) => {
    logger.info("view_top closed.");
    await ack();
});
/** change paramater action */
const joinActionPattern = `${blocks_1.ActionIds.AttendeeNameInputAction}|${blocks_1.ActionIds.DefaultSettingChangeAction}`;
app.action(new RegExp(joinActionPattern), async ({ body, action, ack, respond }) => {
    console.log(`Parameter Updated.`);
    // await ack();// (★１)
    const token = await (0, auth_1.fetchToken)(body.team.id);
    // @ts-ignore
    const actionId = action.action_id;
    // @ts-ignore
    const userInfo = JSON.parse(body.view.private_metadata);
    if (actionId === blocks_1.ActionIds.AttendeeNameInputAction) {
        // @ts-ignore
        userInfo.chimeInfo.attendeeName = action.value;
    }
    else if (actionId === blocks_1.ActionIds.DefaultSettingChangeAction) {
        // @ts-ignore
        const selected = action.selected_options.filter((x) => {
            return x.value === "use-default";
        });
        if (selected.length > 0) {
            userInfo.chimeInfo.useDefault = true;
        }
        else {
            userInfo.chimeInfo.useDefault = false;
        }
    }
    else {
        console.log(`unknown action id... ${actionId}`);
    }
    const urlEncrypter = new encrypter_1.Encrypter({
        password: process.env.SLACK_APP_DB_PASSWORD || "pass",
        salt: process.env.SLACK_APP_DB_SALT || "salt",
        secret: process.env.SLACK_APP_DB_SECRET || "secret",
        expireSec: 60 * 60, // 60min
    });
    const encInfo = urlEncrypter.encodeInformation(userInfo);
    const CHIME_BASE_URL = process.env.DEMO_ENDPOINT;
    // const url = `${CHIME_BASE_URL}/default/index.html?slack_token=${encInfo}&restapi_endpoint_base=${BASE_URL}`;
    // TODO: REST API BASE URL
    const url = `${CHIME_BASE_URL}/default/index.html?slack_token=${encInfo}`;
    console.log(`URL:1:: ${url}`);
    app.client.views.update({
        view_id: body.view.id,
        view: (0, blocks_1.generateJoinModal)(userInfo, url),
        hash: body.view.hash,
        token: token,
    });
    await ack();
    return;
});
/** enter clicked action (Currently nop) */
app.action(blocks_1.ActionIds.EnterMeeting, async ({ body, action, ack, respond }) => {
    console.log("Enter Meeting clicked!");
    // ack();
    // Todo: How to close modal...?
});
const server = awsServerlessExpress.createServer(receiver.app);
module.exports.handler = (event, context, callback) => {
    console.log("⚡️ Bolt app is running!");
    console.log("Event", JSON.stringify(event));
    console.log("Context", JSON.stringify(context));
    console.log(`resource: ${event.resource}`);
    if (event.resource === "/slack/api/{operation}") {
        const operation = event.pathParameters["operation"];
        console.log(`resource: ${operation}`);
        if (operation === "decodeInformation") {
            console.log(`body: ${event.body}`);
            const token = JSON.parse(event.body)["token"];
            console.log(`token: ${token}`);
            const urlEncrypter = new encrypter_1.Encrypter({
                password: process.env.SLACK_APP_DB_PASSWORD || "pass",
                salt: process.env.SLACK_APP_DB_SALT || "salt",
                secret: process.env.SLACK_APP_DB_SECRET || "secret",
                expireSec: 60 * 60, // 60min
            });
            const userInfo = urlEncrypter.decodeInformation(token);
            console.log(`userInfo: ${JSON.stringify(userInfo)}`);
            var response = {
                statusCode: 200,
                headers: {
                    "Access-Control-Allow-Headers": "Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token",
                    "Access-Control-Allow-Methods": "*",
                    "Access-Control-Allow-Origin": "*",
                },
                body: JSON.stringify({
                    success: true,
                    code: "SUCCESS",
                    data: userInfo,
                }),
                isBase64Encoded: false,
            };
            callback(null, response);
        }
    }
    else {
        awsServerlessExpress.proxy(server, event, context);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2xhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEyL2ZlZGVyYXRpb24vc2xhY2svc2xhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0EsNkVBQStEO0FBQy9ELHNDQUE0TjtBQUM1TixpQ0FBK0Y7QUFFL0YscUNBQStFO0FBRy9FLDJDQUF3QztBQUV4QyxNQUFNLFFBQVEsR0FBRyxJQUFJLHNCQUFlLENBQUM7SUFDakMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLElBQUksRUFBRTtJQUNyRCxTQUFTLEVBQUUsZUFBZTtJQUMxQixRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksRUFBRTtJQUMzQyxZQUFZLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxFQUFFO0lBQ25ELFdBQVcsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLEVBQUU7SUFDakQsTUFBTSxFQUFFLENBQUMsa0JBQWtCLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLENBQUM7SUFDdEYsaUJBQWlCLEVBQUU7UUFDZixpQkFBaUIsRUFBRSxLQUFLLEVBQW1DLFlBQWdELEVBQUUsRUFBRTtZQUMzRyxNQUFNLElBQUEseUJBQWtCLEVBQUMsWUFBWSxDQUFDLENBQUM7WUFDdkMsT0FBTztRQUNYLENBQUM7UUFDRCxhQUFhO1FBQ2IsaUJBQWlCLEVBQUUsS0FBSyxFQUFFLFlBQXdDLEVBQUUsRUFBRTtZQUNsRSxNQUFNLEtBQUssR0FBRyxNQUFNLElBQUEsd0JBQWlCLEVBQUMsWUFBWSxDQUFDLENBQUM7WUFDcEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9DLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7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SSxNQUFNO2dCQUNyRCxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxNQUFNO2dCQUM3QyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxRQUFRO2dCQUNuRCxTQUFTLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxRQUFRO2FBQy9CLENBQUMsQ0FBQztZQUVILE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2RCxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFckQsSUFBSSxRQUFRLEdBQUc7Z0JBQ1gsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsT0FBTyxFQUFFO29CQUNMLDhCQUE4QixFQUFFLHNFQUFzRTtvQkFDdEcsOEJBQThCLEVBQUUsR0FBRztvQkFDbkMsNkJBQTZCLEVBQUUsR0FBRztpQkFDckM7Z0JBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7b0JBQ2pCLE9BQU8sRUFBRSxJQUFJO29CQUNiLElBQUksRUFBRSxTQUFTO29CQUNmLElBQUksRUFBRSxRQUFRO2lCQUNqQixDQUFDO2dCQUNGLGVBQWUsRUFBRSxLQUFLO2FBQ3pCLENBQUM7WUFDRixRQUFRLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1NBQzVCO0tBQ0o7U0FBTTtRQUNILG9CQUFvQixDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ3REO0FBQ0wsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheUV2ZW50LCBDb250ZXh0IGFzIExhbWJkYUNvbnRleHQgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xuaW1wb3J0ICogYXMgYXdzU2VydmVybGVzc0V4cHJlc3MgZnJvbSBcImF3cy1zZXJ2ZXJsZXNzLWV4cHJlc3NcIjtcbmltcG9ydCB7IEFwcCwgRXhwcmVzc1JlY2VpdmVyLCBWaWV3U3VibWl0QWN0aW9uLCBDb250ZXh0LCBMb2dMZXZlbCwgQ29kZWRFcnJvciwgQmxvY2tBY3Rpb24sIFN0YXRpY1NlbGVjdEFjdGlvbiwgUmFkaW9CdXR0b25zQWN0aW9uLCBHbG9iYWxTaG9ydGN1dCwgSW5zdGFsbGF0aW9uLCBJbnN0YWxsYXRpb25RdWVyeSwgQXBwT3B0aW9ucywgVmlldyB9IGZyb20gXCJAc2xhY2svYm9sdFwiO1xuaW1wb3J0IHsgYWRkVGVhbUluZm9ybWF0aW9uLCBkZWxldGVJbnN0YWxsYXRpb24sIGZldGNoSW5zdGFsbGF0aW9uLCBmZXRjaFRva2VuIH0gZnJvbSBcIi4vYXV0aFwiO1xuaW1wb3J0IHsgdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0IHsgQWN0aW9uSWRzLCBnZW5lcmF0ZUNvbnRyb2xCbG9ja3MsIGdlbmVyYXRlSm9pbk1vZGFsIH0gZnJvbSBcIi4vYmxvY2tzXCI7XG5pbXBvcnQgeyBSb29tSW5mbyB9IGZyb20gXCIuL2RhdGEvcm9vbVwiO1xuaW1wb3J0IHsgQ2hpbWVJbmZvLCBVc2VySW5mb3JtYXRpb24gfSBmcm9tIFwiLi9kYXRhL3VzZXJJbmZvXCI7XG5pbXBvcnQgeyBFbmNyeXB0ZXIgfSBmcm9tIFwiLi9lbmNyeXB0ZXJcIjtcblxuY29uc3QgcmVjZWl2ZXIgPSBuZXcgRXhwcmVzc1JlY2VpdmVyKHtcbiAgICBzaWduaW5nU2VjcmV0OiBwcm9jZXNzLmVudi5TTEFDS19TSUdOSU5HX1NFQ1JFVCB8fCBcIlwiLFxuICAgIGVuZHBvaW50czogYC9zbGFjay9ldmVudHNgLFxuICAgIGNsaWVudElkOiBwcm9jZXNzLmVudi5TTEFDS19DTElFTlRfSUQgfHwgXCJcIixcbiAgICBjbGllbnRTZWNyZXQ6IHByb2Nlc3MuZW52LlNMQUNLX0NMSUVOVF9TRUNSRVQgfHwgXCJcIixcbiAgICBzdGF0ZVNlY3JldDogcHJvY2Vzcy5lbnYuU0xBQ0tfU1RBVEVfU0VDUkVUIHx8IFwiXCIsXG4gICAgc2NvcGVzOiBbXCJjaGFubmVsczpoaXN0b3J5XCIsIFwiY2hhdDp3cml0ZVwiLCBcImNvbW1hbmRzXCIsIFwiZ3JvdXBzOmhpc3RvcnlcIiwgXCJ1c2VyczpyZWFkXCJdLFxuICAgIGluc3RhbGxhdGlvblN0b3JlOiB7XG4gICAgICAgIHN0b3JlSW5zdGFsbGF0aW9uOiBhc3luYyA8QXV0aFZlcnNpb24gZXh0ZW5kcyBcInYxXCIgfCBcInYyXCI+KGluc3RhbGxhdGlvbjogSW5zdGFsbGF0aW9uPEF1dGhWZXJzaW9uLCBib29sZWFuPikgPT4ge1xuICAgICAgICAgICAgYXdhaXQgYWRkVGVhbUluZm9ybWF0aW9uKGluc3RhbGxhdGlvbik7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH0sXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgZmV0Y2hJbnN0YWxsYXRpb246IGFzeW5jIChpbnN0YWxsUXVlcnk6IEluc3RhbGxhdGlvblF1ZXJ5PGJvb2xlYW4+KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0b2tlbiA9IGF3YWl0IGZldGNoSW5zdGFsbGF0aW9uKGluc3RhbGxRdWVyeSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgRkVUQ0g6ICR7SlNPTi5zdHJpbmdpZnkodG9rZW4pfWApO1xuICAgICAgICAgICAgcmV0dXJuIHRva2VuO1xuICAgICAgICB9LFxuICAgICAgICBkZWxldGVJbnN0YWxsYXRpb246IGFzeW5jIChpbnN0YWxsUXVlcnk6IEluc3RhbGxhdGlvblF1ZXJ5PGJvb2xlYW4+KSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBkZWxldGVJbnN0YWxsYXRpb24oaW5zdGFsbFF1ZXJ5KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSxcbiAgICB9LFxuICAgIGluc3RhbGxlck9wdGlvbnM6IHtcbiAgICAgICAgZGlyZWN0SW5zdGFsbDogdHJ1ZSxcbiAgICB9LFxufSk7XG5jb25zdCBjb25maWc6IEFwcE9wdGlvbnMgPSB7XG4gICAgcmVjZWl2ZXIsXG4gICAgLy8gdG9rZW46IHByb2Nlc3MuZW52LlNMQUNLX0JPVF9UT0tFTiwgLy8gZm9yIG9uZSB3b3Jrc3BhY2XopIfmlbDjg6/jg7zjgq/jgrnjg5rjg7zjgrnjga7loLTlkIjjga9vYXV0aCBpbnN0YWxsZXIgb3IgYXV0aG9yaXpl44KS5L2/44GI44Go44CCXG4gICAgLy8gc2lnbmluZ1NlY3JldDogcHJvY2Vzcy5lbnYuU0xBQ0tfU0lHTklOR19TRUNSRVQsXG4gICAgLy8gbG9nTGV2ZWw6IExvZ0xldmVsLkRFQlVHLFxuICAgIC8vIHByb2Nlc3NCZWZvcmVSZXNwb25zZTogdHJ1ZSxcbn07XG5cbmNvbnN0IGFwcCA9IG5ldyBBcHAoY29uZmlnKTtcblxuLy8vLy8vLy8gKGEpIHNsYXNoIGNvbW1hbmRcbmFwcC5jb21tYW5kKFwiL2NoaW1lLW1lZXRpbmdcIiwgYXN5bmMgKHsgY29tbWFuZCwgYWNrLCBzYXkgfSkgPT4ge1xuICAgIC8vIGF3YWl0IGFjaygpOyAvL+OAgCjimIXvvJEp44Gq44Gc44GLYWNr5b6M44GrcG9zdOOBjOOBp+OBjeOBquOBhOOBruOBp+acgOW+jOOBq2Fja+OBmeOCi+OAguOBquOBiuOAgWFja+OBl+OBquOBhOOBqHNsYWNr5YG044GndGltZW91dOOBjOeZuueUn+OBl+OBpuOBl+OBvuOBhuOAglxuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgZmV0Y2hUb2tlbihjb21tYW5kLnRlYW1faWQpO1xuICAgIGNvbnNvbGUubG9nKGBHRVQgVE9LRU46ICR7dG9rZW4uc3Vic3RyaW5nKDAsIDEwKX0uLi5gKTtcbiAgICAvLyAvLy8vIGhlbHDjgpLlhaXlipvjgZXjgozjgZ/loLTlkIhcbiAgICAvLyBpZiAoY29tbWFuZC50ZXh0ID09PSBcImhlbHBcIikge1xuICAgIC8vICAgICBjb25zdCBoZWxwQmxvY2tzID0gZ2VuZXJhdGVIZWxwQmxvY2tzKCk7XG4gICAgLy8gICAgIGFwcC5jbGllbnQuY2hhdC5wb3N0RXBoZW1lcmFsKHtcbiAgICAvLyAgICAgICAgIGNoYW5uZWw6IGNvbW1hbmQuY2hhbm5lbF9pZCxcbiAgICAvLyAgICAgICAgIGJsb2NrczogaGVscEJsb2NrcyxcbiAgICAvLyAgICAgICAgIHVzZXI6IGNvbW1hbmQudXNlcl9pZCxcbiAgICAvLyAgICAgICAgIHRva2VuOiB0b2tlbixcbiAgICAvLyAgICAgfSk7XG4gICAgLy8gICAgIHJldHVybjtcbiAgICAvLyB9XG5cbiAgICAvLy8g6YCa5bi444Kx44O844K5XG4gICAgY29uc3Qgcm9vbU5hbWUgPSBjb21tYW5kLnRleHQ7XG4gICAgY29uc3Qgcm9vbUluZm86IFJvb21JbmZvID0ge1xuICAgICAgICByb29tTmFtZTogcm9vbU5hbWUsXG4gICAgICAgIHRlYW1JZDogXCJcIixcbiAgICAgICAgY2hhbm5lbElkOiBcIlwiLFxuICAgICAgICBjaGFubmVsTmFtZTogXCJcIixcbiAgICAgICAgdHM6IFwiXCIsXG4gICAgICAgIGF0dGVuZGVlczogW10sXG4gICAgICAgIHR0bDogMCxcbiAgICB9O1xuICAgIGNvbnN0IGNvbnRyb2xCbG9ja3MgPSBnZW5lcmF0ZUNvbnRyb2xCbG9ja3Mocm9vbUluZm8pO1xuXG4gICAgY29uc3QgbXNnID0ge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNoYW5uZWw6IGNvbW1hbmQuY2hhbm5lbF9pZCxcbiAgICAgICAgLy8gdG9rZW46IHByb2Nlc3MuZW52LlNMQUNLX0JPVF9UT0tFTixcbiAgICAgICAgdG9rZW46IHRva2VuLFxuICAgICAgICBibG9ja3M6IGNvbnRyb2xCbG9ja3MsXG4gICAgICAgIHRleHQ6IFwicmVuZGVyaW5nIGZhaWxlZD8/XCIsXG4gICAgfTtcbiAgICBjb25zdCBwb3N0UmVzdWx0ID0gYXdhaXQgYXBwLmNsaWVudC5jaGF0LnBvc3RNZXNzYWdlKG1zZyk7XG4gICAgY29uc3QgdHMgPSBwb3N0UmVzdWx0LnRzO1xuICAgIHJvb21JbmZvLnRzID0gdHM7XG5cbiAgICBhY2soKTsgLy8gKOKYhe+8kSlcbn0pO1xuXG4vLy8vLy8vLyAoYikgSm9pbiBidXR0b24gY2xpY2tlZC5cbmFwcC5hY3Rpb24oXCJqb2luXCIsIGFzeW5jICh7IGNsaWVudCwgY29udGV4dCwgYm9keSwgYWN0aW9uLCBhY2ssIGxvZ2dlciB9KSA9PiB7XG4gICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoY2xpZW50LnNsYWNrQXBpVXJsKSk7XG4gICAgY29uc29sZS5sb2coYEpPSU4gQnV0dG9uIENsaWNrZWRgKTtcbiAgICAvLyBhd2FpdCBhY2soKTsvLyAo4piF77yRKVxuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgZmV0Y2hUb2tlbihib2R5LnRlYW0uaWQpO1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBhcHAuY2xpZW50LnVzZXJzLmluZm8oeyB1c2VyOiBib2R5LnVzZXIuaWQsIHRva2VuOiB0b2tlbiB9KTtcbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3Qgcm9vbU5hbWUgPSBhY3Rpb24udmFsdWU7XG4gICAgY29uc3QgdXNlckluZm86IFVzZXJJbmZvcm1hdGlvbiA9IHtcbiAgICAgICAgcm9vbU5hbWU6IHJvb21OYW1lLFxuICAgICAgICB0ZWFtSWQ6IGJvZHkudGVhbS5pZCxcbiAgICAgICAgY2hhbm5lbElkOiBib2R5LmNoYW5uZWwuaWQsXG4gICAgICAgIGNoYW5uZWxOYW1lOiBib2R5LmNoYW5uZWwubmFtZSxcbiAgICAgICAgdXNlcklkOiBib2R5LnVzZXIuaWQsXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdXNlck5hbWU6IGJvZHkudXNlci51c2VybmFtZSxcbiAgICAgICAgaW1hZ2VVcmw6IHVzZXJbXCJ1c2VyXCJdW1wicHJvZmlsZVwiXVtcImltYWdlXzE5MlwiXSxcbiAgICAgICAgY2hpbWVJbmZvOiB7XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBhdHRlbmRlZU5hbWU6IGJvZHkudXNlci51c2VybmFtZSxcbiAgICAgICAgICAgIHVzZURlZmF1bHQ6IHRydWUsXG4gICAgICAgIH0sXG4gICAgfTtcbiAgICBjb25zb2xlLmxvZyhgVXNlciBJbmZvOiAke0pTT04uc3RyaW5naWZ5KHVzZXJJbmZvKX1gKTtcbiAgICBpZiAoIXVzZXJJbmZvLnJvb21OYW1lKSB7XG4gICAgICAgIGFwcC5jbGllbnQuY2hhdC5wb3N0RXBoZW1lcmFsKHtcbiAgICAgICAgICAgIGNoYW5uZWw6IHVzZXJJbmZvLmNoYW5uZWxJZCxcbiAgICAgICAgICAgIHRleHQ6IGBST09NWyR7dXNlckluZm8ucm9vbU5hbWV9XSBub3QgZm91bmRgLFxuICAgICAgICAgICAgdXNlcjogdXNlckluZm8udXNlcklkLFxuICAgICAgICAgICAgdG9rZW46IHRva2VuLFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHVybEVuY3J5cHRlciA9IG5ldyBFbmNyeXB0ZXI8VXNlckluZm9ybWF0aW9uPih7XG4gICAgICAgIHBhc3N3b3JkOiBwcm9jZXNzLmVudi5TTEFDS19BUFBfREJfUEFTU1dPUkQgfHwgXCJwYXNzXCIsXG4gICAgICAgIHNhbHQ6IHByb2Nlc3MuZW52LlNMQUNLX0FQUF9EQl9TQUxUIHx8IFwic2FsdFwiLFxuICAgICAgICBzZWNyZXQ6IHByb2Nlc3MuZW52LlNMQUNLX0FQUF9EQl9TRUNSRVQgfHwgXCJzZWNyZXRcIixcbiAgICAgICAgZXhwaXJlU2VjOiA2MCAqIDYwLCAvLyA2MG1pblxuICAgIH0pO1xuXG4gICAgY29uc3QgZW5jSW5mbyA9IHVybEVuY3J5cHRlci5lbmNvZGVJbmZvcm1hdGlvbih1c2VySW5mbyk7XG4gICAgY29uc3QgQ0hJTUVfQkFTRV9VUkwgPSBwcm9jZXNzLmVudi5ERU1PX0VORFBPSU5UO1xuICAgIC8vIGNvbnN0IHVybCA9IGAke0NISU1FX0JBU0VfVVJMfS9kZWZhdWx0L2luZGV4Lmh0bWw/c2xhY2tfdG9rZW49JHtlbmNJbmZvfSZyZXN0YXBpX2VuZHBvaW50X2Jhc2U9JHtCQVNFX1VSTH1gO1xuICAgIC8vIFRPRE86IFJFU1QgQVBJIEJBU0UgVVJMXG4gICAgY29uc3QgdXJsID0gYCR7Q0hJTUVfQkFTRV9VUkx9L2RlZmF1bHQvaW5kZXguaHRtbD9zbGFja190b2tlbj0ke2VuY0luZm99YDtcbiAgICBjb25zb2xlLmxvZyhgVVJMOjo6ICR7dXJsfWApO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IGFwcC5jbGllbnQudmlld3Mub3Blbih7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgdHJpZ2dlcl9pZDogYm9keS50cmlnZ2VyX2lkLFxuICAgICAgICB0b2tlbjogdG9rZW4sXG4gICAgICAgIHZpZXc6IGdlbmVyYXRlSm9pbk1vZGFsKHVzZXJJbmZvLCB1cmwpIGFzIFZpZXcsXG4gICAgfSk7XG4gICAgaWYgKCFyZXMub2spIHtcbiAgICAgICAgbG9nZ2VyLmluZm8oYEZhaWxlZCB0byBvcGVuIGEgbW9kYWwgLSAke0pTT04uc3RyaW5naWZ5KHJlcyl9YCk7XG4gICAgfVxuXG4gICAgYWNrKCk7IC8vICjimIXvvJEpXG4gICAgcmV0dXJuO1xufSk7XG5cbi8vLy8vLy8vIChjKSBKb2luIE1vZGFsXG4vKiogc2hvdyDjgYTjgonjgarjgYTvvJ/vvJ8qL1xuYXBwLnZpZXcoXCJqb2luX21vZGFsXCIsIGFzeW5jICh7IHBheWxvYWQsIHZpZXcsIGJvZHksIGFjayB9KSA9PiB7XG4gICAgY29uc29sZS5sb2coXCJWSUVXX1RPUCBDQUxMRUQhXCIpO1xuICAgIGNvbnNvbGUubG9nKFwicGF5bG9hZFwiLCBKU09OLnN0cmluZ2lmeShwYXlsb2FkKSk7XG4gICAgY29uc29sZS5sb2coXCJ2aWV3XCIsIEpTT04uc3RyaW5naWZ5KHZpZXcpKTtcbiAgICBjb25zb2xlLmxvZyhcImJvZHlcIiwgSlNPTi5zdHJpbmdpZnkoYm9keSkpO1xuICAgIGF3YWl0IGFjayh7XG4gICAgICAgIHJlc3BvbnNlX2FjdGlvbjogXCJ1cGRhdGVcIixcbiAgICAgICAgdmlldzoge1xuICAgICAgICAgICAgdHlwZTogXCJtb2RhbFwiLFxuICAgICAgICAgICAgY2FsbGJhY2tfaWQ6IFwidmlld19jb21wbGV0aW9uXCIsXG5cbiAgICAgICAgICAgIHRpdGxlOiB7XG4gICAgICAgICAgICAgICAgdHlwZTogXCJwbGFpbl90ZXh0XCIsXG4gICAgICAgICAgICAgICAgdGV4dDogXCJNeSBBcGFhc2QtXCIsXG4gICAgICAgICAgICAgICAgZW1vamk6IHRydWUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYmxvY2tzOiBbXSxcbiAgICAgICAgfSxcbiAgICB9KTtcbn0pO1xuLyoqIGNsb3NlIGFjdGlvbiAqL1xuYXBwLnZpZXcoeyBjYWxsYmFja19pZDogXCJqb2luX21vZGFsXCIsIHR5cGU6IFwidmlld19jbG9zZWRcIiB9LCBhc3luYyAoeyBhY2ssIGxvZ2dlciB9KSA9PiB7XG4gICAgbG9nZ2VyLmluZm8oXCJ2aWV3X3RvcCBjbG9zZWQuXCIpO1xuICAgIGF3YWl0IGFjaygpO1xufSk7XG4vKiogY2hhbmdlIHBhcmFtYXRlciBhY3Rpb24gKi9cbmNvbnN0IGpvaW5BY3Rpb25QYXR0ZXJuID0gYCR7QWN0aW9uSWRzLkF0dGVuZGVlTmFtZUlucHV0QWN0aW9ufXwke0FjdGlvbklkcy5EZWZhdWx0U2V0dGluZ0NoYW5nZUFjdGlvbn1gO1xuYXBwLmFjdGlvbihuZXcgUmVnRXhwKGpvaW5BY3Rpb25QYXR0ZXJuKSwgYXN5bmMgKHsgYm9keSwgYWN0aW9uLCBhY2ssIHJlc3BvbmQgfSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKGBQYXJhbWV0ZXIgVXBkYXRlZC5gKTtcbiAgICAvLyBhd2FpdCBhY2soKTsvLyAo4piF77yRKVxuICAgIGNvbnN0IHRva2VuID0gYXdhaXQgZmV0Y2hUb2tlbihib2R5LnRlYW0uaWQpO1xuICAgIC8vIEB0cy1pZ25vcmVcbiAgICBjb25zdCBhY3Rpb25JZCA9IGFjdGlvbi5hY3Rpb25faWQ7XG4gICAgLy8gQHRzLWlnbm9yZVxuICAgIGNvbnN0IHVzZXJJbmZvID0gSlNPTi5wYXJzZShib2R5LnZpZXcucHJpdmF0ZV9tZXRhZGF0YSkgYXMgVXNlckluZm9ybWF0aW9uO1xuXG4gICAgaWYgKGFjdGlvbklkID09PSBBY3Rpb25JZHMuQXR0ZW5kZWVOYW1lSW5wdXRBY3Rpb24pIHtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICB1c2VySW5mby5jaGltZUluZm8uYXR0ZW5kZWVOYW1lID0gYWN0aW9uLnZhbHVlO1xuICAgIH0gZWxzZSBpZiAoYWN0aW9uSWQgPT09IEFjdGlvbklkcy5EZWZhdWx0U2V0dGluZ0NoYW5nZUFjdGlvbikge1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkID0gYWN0aW9uLnNlbGVjdGVkX29wdGlvbnMuZmlsdGVyKCh4KSA9PiB7XG4gICAgICAgICAgICByZXR1cm4geC52YWx1ZSA9PT0gXCJ1c2UtZGVmYXVsdFwiO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKHNlbGVjdGVkLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHVzZXJJbmZvLmNoaW1lSW5mby51c2VEZWZhdWx0ID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHVzZXJJbmZvLmNoaW1lSW5mby51c2VEZWZhdWx0ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhgdW5rbm93biBhY3Rpb24gaWQuLi4gJHthY3Rpb25JZH1gKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cmxFbmNyeXB0ZXIgPSBuZXcgRW5jcnlwdGVyPFVzZXJJbmZvcm1hdGlvbj4oe1xuICAgICAgICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuU0xBQ0tfQVBQX0RCX1BBU1NXT1JEIHx8IFwicGFzc1wiLFxuICAgICAgICBzYWx0OiBwcm9jZXNzLmVudi5TTEFDS19BUFBfREJfU0FMVCB8fCBcInNhbHRcIixcbiAgICAgICAgc2VjcmV0OiBwcm9jZXNzLmVudi5TTEFDS19BUFBfREJfU0VDUkVUIHx8IFwic2VjcmV0XCIsXG4gICAgICAgIGV4cGlyZVNlYzogNjAgKiA2MCwgLy8gNjBtaW5cbiAgICB9KTtcblxuICAgIGNvbnN0IGVuY0luZm8gPSB1cmxFbmNyeXB0ZXIuZW5jb2RlSW5mb3JtYXRpb24odXNlckluZm8pO1xuICAgIGNvbnN0IENISU1FX0JBU0VfVVJMID0gcHJvY2Vzcy5lbnYuREVNT19FTkRQT0lOVDtcbiAgICAvLyBjb25zdCB1cmwgPSBgJHtDSElNRV9CQVNFX1VSTH0vZGVmYXVsdC9pbmRleC5odG1sP3NsYWNrX3Rva2VuPSR7ZW5jSW5mb30mcmVzdGFwaV9lbmRwb2ludF9iYXNlPSR7QkFTRV9VUkx9YDtcbiAgICAvLyBUT0RPOiBSRVNUIEFQSSBCQVNFIFVSTFxuICAgIGNvbnN0IHVybCA9IGAke0NISU1FX0JBU0VfVVJMfS9kZWZhdWx0L2luZGV4Lmh0bWw/c2xhY2tfdG9rZW49JHtlbmNJbmZvfWA7XG4gICAgY29uc29sZS5sb2coYFVSTDoxOjogJHt1cmx9YCk7XG5cbiAgICBhcHAuY2xpZW50LnZpZXdzLnVwZGF0ZSh7XG4gICAgICAgIHZpZXdfaWQ6IChib2R5IGFzIEJsb2NrQWN0aW9uKS52aWV3LmlkLFxuICAgICAgICB2aWV3OiBnZW5lcmF0ZUpvaW5Nb2RhbCh1c2VySW5mbywgdXJsKSBhcyBWaWV3LFxuICAgICAgICBoYXNoOiAoYm9keSBhcyBCbG9ja0FjdGlvbikudmlldy5oYXNoLFxuICAgICAgICB0b2tlbjogdG9rZW4sXG4gICAgfSk7XG4gICAgYXdhaXQgYWNrKCk7XG4gICAgcmV0dXJuO1xufSk7XG5cbi8qKiBlbnRlciBjbGlja2VkIGFjdGlvbiAoQ3VycmVudGx5IG5vcCkgKi9cbmFwcC5hY3Rpb24oQWN0aW9uSWRzLkVudGVyTWVldGluZywgYXN5bmMgKHsgYm9keSwgYWN0aW9uLCBhY2ssIHJlc3BvbmQgfSkgPT4ge1xuICAgIGNvbnNvbGUubG9nKFwiRW50ZXIgTWVldGluZyBjbGlja2VkIVwiKTtcbiAgICAvLyBhY2soKTtcbiAgICAvLyBUb2RvOiBIb3cgdG8gY2xvc2UgbW9kYWwuLi4/XG59KTtcblxuY29uc3Qgc2VydmVyID0gYXdzU2VydmVybGVzc0V4cHJlc3MuY3JlYXRlU2VydmVyKHJlY2VpdmVyLmFwcCk7XG5tb2R1bGUuZXhwb3J0cy5oYW5kbGVyID0gKGV2ZW50OiBBUElHYXRld2F5RXZlbnQsIGNvbnRleHQ6IExhbWJkYUNvbnRleHQsIGNhbGxiYWNrOiBhbnkpID0+IHtcbiAgICBjb25zb2xlLmxvZyhcIuKaoe+4jyBCb2x0IGFwcCBpcyBydW5uaW5nIVwiKTtcbiAgICBjb25zb2xlLmxvZyhcIkV2ZW50XCIsIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG4gICAgY29uc29sZS5sb2coXCJDb250ZXh0XCIsIEpTT04uc3RyaW5naWZ5KGNvbnRleHQpKTtcbiAgICBjb25zb2xlLmxvZyhgcmVzb3VyY2U6ICR7ZXZlbnQucmVzb3VyY2V9YCk7XG4gICAgaWYgKGV2ZW50LnJlc291cmNlID09PSBcIi9zbGFjay9hcGkve29wZXJhdGlvbn1cIikge1xuICAgICAgICBjb25zdCBvcGVyYXRpb24gPSBldmVudC5wYXRoUGFyYW1ldGVyc1tcIm9wZXJhdGlvblwiXTtcbiAgICAgICAgY29uc29sZS5sb2coYHJlc291cmNlOiAke29wZXJhdGlvbn1gKTtcbiAgICAgICAgaWYgKG9wZXJhdGlvbiA9PT0gXCJkZWNvZGVJbmZvcm1hdGlvblwiKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgYm9keTogJHtldmVudC5ib2R5fWApO1xuICAgICAgICAgICAgY29uc3QgdG9rZW4gPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpW1widG9rZW5cIl07XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgdG9rZW46ICR7dG9rZW59YCk7XG5cbiAgICAgICAgICAgIGNvbnN0IHVybEVuY3J5cHRlciA9IG5ldyBFbmNyeXB0ZXI8VXNlckluZm9ybWF0aW9uPih7XG4gICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LlNMQUNLX0FQUF9EQl9QQVNTV09SRCB8fCBcInBhc3NcIixcbiAgICAgICAgICAgICAgICBzYWx0OiBwcm9jZXNzLmVudi5TTEFDS19BUFBfREJfU0FMVCB8fCBcInNhbHRcIixcbiAgICAgICAgICAgICAgICBzZWNyZXQ6IHByb2Nlc3MuZW52LlNMQUNLX0FQUF9EQl9TRUNSRVQgfHwgXCJzZWNyZXRcIixcbiAgICAgICAgICAgICAgICBleHBpcmVTZWM6IDYwICogNjAsIC8vIDYwbWluXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgdXNlckluZm8gPSB1cmxFbmNyeXB0ZXIuZGVjb2RlSW5mb3JtYXRpb24odG9rZW4pO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYHVzZXJJbmZvOiAke0pTT04uc3RyaW5naWZ5KHVzZXJJbmZvKX1gKTtcblxuICAgICAgICAgICAgdmFyIHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVyc1wiOiBcIkNvbnRlbnQtVHlwZSxYLUFtei1EYXRlLEF1dGhvcml6YXRpb24sWC1BcGktS2V5LFgtQW16LVNlY3VyaXR5LVRva2VuXCIsXG4gICAgICAgICAgICAgICAgICAgIFwiQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kc1wiOiBcIipcIixcbiAgICAgICAgICAgICAgICAgICAgXCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW5cIjogXCIqXCIsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IFwiU1VDQ0VTU1wiLFxuICAgICAgICAgICAgICAgICAgICBkYXRhOiB1c2VySW5mbyxcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBpc0Jhc2U2NEVuY29kZWQ6IGZhbHNlLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAgIGF3c1NlcnZlcmxlc3NFeHByZXNzLnByb3h5KHNlcnZlciwgZXZlbnQsIGNvbnRleHQpO1xuICAgIH1cbn07XG4iXX0=