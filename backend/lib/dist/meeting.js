"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.stopTranscribe = exports.startTranscribe = exports.getAttendeeInfo = exports.joinMeeting = exports.createMeeting = exports.deleteMeeting = exports.getMeetingInfo = void 0;
const aws_sdk_1 = require("aws-sdk");
const uuid_1 = require("uuid");
const backend_request_1 = require("./backend_request");
const util_1 = require("./util");
var meetingTableName = process.env.MEETING_TABLE_NAME;
var attendeesTableName = process.env.ATTENDEE_TABLE_NAME;
var ddb = new aws_sdk_1.DynamoDB();
const chime = new aws_sdk_1.Chime({ region: "us-east-1" });
chime.endpoint = new aws_sdk_1.Endpoint("https://service.chime.aws.amazon.com/console");
/**
 * get meeting info
 * (1) retrieve meeting info from DB
 * (2) If there is no meeting in DB, return null
 * (3) If there is no meeting in Amazon Chime, delete from DB and return null.
 * @param {*} meetingName
 */
const getMeetingInfo = async (req) => {
    //// (1) retrieve info
    console.log("dynamo1", req.meetingName);
    const result = await ddb.getItem({ TableName: meetingTableName, Key: { MeetingName: { S: req.meetingName } } }).promise();
    console.log("dynamo2", result);
    //// (2) If no meeting in DB, return null
    if (!result.Item) {
        return null;
    }
    //// (3) If no meeting in Chime, delete meeting from DB and return null
    const meetingInfo = result.Item;
    console.log("READ PROPR1");
    const meetingData = JSON.parse(meetingInfo.Meeting.S);
    console.log("READ PROPR2");
    try {
        // Check Exist?
        const mid = await chime.getMeeting({ MeetingId: meetingData.MeetingId }).promise();
        console.log("chime meeting info:", mid);
    }
    catch (err) {
        console.log("chime meeting exception:", err);
        await (0, exports.deleteMeeting)({ meetingName: req.meetingName });
        return null;
    }
    console.log("READ PROPR3");
    //// (4) return meeting info
    return {
        meetingName: meetingInfo.MeetingName.S,
        meetingId: meetingInfo.MeetingId.S,
        meeting: JSON.parse(meetingInfo.Meeting.S),
        metadata: JSON.parse(meetingInfo.Metadata.S),
        hmmTaskArn: meetingInfo.HmmTaskArn ? meetingInfo.HmmTaskArn.S : "-",
        isOwner: req.email === JSON.parse(meetingInfo.Metadata.S).OwnerId,
    };
};
exports.getMeetingInfo = getMeetingInfo;
/**
 * Delete meeting from DB
 * @param {*} meetingName
 */
const deleteMeeting = async (req) => {
    await ddb
        .deleteItem({
        TableName: meetingTableName,
        Key: {
            MeetingName: { S: req.meetingName },
        },
    })
        .promise();
};
exports.deleteMeeting = deleteMeeting;
const createMeeting = async (req) => {
    //// (1) check meeting name exist
    const meetingInfo = await (0, exports.getMeetingInfo)({ meetingName: req.meetingName });
    if (meetingInfo !== null) {
        return {
            created: false,
            meetingId: meetingInfo.meetingId,
            meetingName: meetingInfo.meetingName,
            ownerId: meetingInfo.metadata.OwnerId,
        };
    }
    //// (2) create meeting in Amazon Chime
    const request = {
        ClientRequestToken: (0, uuid_1.v4)(),
        MediaRegion: req.region,
    };
    const newMeetingInfo = await chime.createMeeting(request).promise();
    //// (3) register meeting info in DB
    const date = new Date();
    const now = date.getTime();
    const metadata = {
        OwnerId: req.email,
        Region: req.region,
        StartTime: now,
    };
    const item = {
        MeetingName: { S: req.meetingName },
        MeetingId: { S: newMeetingInfo.Meeting.MeetingId },
        Meeting: { S: JSON.stringify(newMeetingInfo.Meeting) },
        Metadata: { S: JSON.stringify(metadata) },
        TTL: {
            N: "" + (0, util_1.getExpireDate)(),
        },
    };
    await ddb
        .putItem({
        TableName: meetingTableName,
        Item: item,
    })
        .promise();
    return {
        created: true,
        meetingId: newMeetingInfo.Meeting.MeetingId,
        meetingName: req.meetingName,
        ownerId: req.email,
    };
};
exports.createMeeting = createMeeting;
const joinMeeting = async (req) => {
    //// (1) check meeting exists
    let meetingInfo = await (0, exports.getMeetingInfo)({ meetingName: req.meetingName });
    if (meetingInfo === null) {
        return {
            code: backend_request_1.BackendJoinMeetingExceptionType.NO_MEETING_FOUND,
            exception: true,
        };
    }
    //// (2) check attendeeName
    if (req.attendeeName === "") {
        return {
            code: backend_request_1.BackendJoinMeetingExceptionType.PARAMETER_ERROR,
            exception: true,
        };
    }
    //// (3) create attendee in Amazon Chime
    console.info("Adding new attendee");
    const attendeeInfo = await chime
        .createAttendee({
        MeetingId: meetingInfo.meetingId,
        ExternalUserId: (0, uuid_1.v4)(),
    })
        .promise();
    //// (4) register attendee in DB
    await ddb
        .putItem({
        TableName: attendeesTableName,
        Item: {
            AttendeeId: {
                S: `${req.meetingName}/${attendeeInfo.Attendee.AttendeeId}`,
            },
            AttendeeName: { S: req.attendeeName },
            TTL: {
                N: "" + (0, util_1.getExpireDate)(),
            },
        },
    })
        .promise();
    console.log("MEETING_INFO", meetingInfo);
    return {
        meetingName: meetingInfo.meetingName,
        meeting: meetingInfo.meeting,
        attendee: attendeeInfo.Attendee,
    };
};
exports.joinMeeting = joinMeeting;
const getAttendeeInfo = async (req) => {
    //// (1) retrieve attendee info from DB. key is concatinate of meetingName(encoded) and attendeeId
    const result = await ddb
        .getItem({
        TableName: attendeesTableName,
        Key: {
            AttendeeId: {
                S: `${req.meetingName}/${req.attendeeId}`,
            },
        },
    })
        .promise();
    //// (2) If there is no attendee in the meeting, return fail
    if (!result.Item) {
        return {
            code: backend_request_1.BackendGetAttendeeInfoExceptionType.NO_ATTENDEE_FOUND,
            exception: true,
        };
    }
    console.log(result);
    //// (3) return attendee info.
    return {
        attendeeId: result.Item.AttendeeId.S,
        attendeeName: result.Item.AttendeeName.S,
    };
};
exports.getAttendeeInfo = getAttendeeInfo;
const startTranscribe = async (req) => {
    //// (1) check meeting exists
    let meetingInfo = await (0, exports.getMeetingInfo)({ meetingName: req.meetingName });
    if (meetingInfo === null) {
        return {
            code: backend_request_1.BackendStartTranscribeExceptionType.NO_MEETING_FOUND,
            exception: true,
        };
    }
    //// (2) check if owner calls or not.
    var meetingMetadata = meetingInfo.metadata;
    var ownerId = meetingMetadata["OwnerId"];
    console.log("OWNERID", ownerId, "email", req.email);
    if (ownerId != req.email) {
        return {
            code: backend_request_1.BackendStartTranscribeExceptionType.NOT_OWNER,
            exception: true,
        };
    }
    //// (3) start transcribe
    console.log(`Langage code :${req.lang}`);
    const res = await chime
        .startMeetingTranscription({
        MeetingId: meetingInfo.meetingId,
        TranscriptionConfiguration: {
            EngineTranscribeSettings: {
                LanguageCode: req.lang,
                //VocabularyFilterMethod?: TranscribeVocabularyFilterMethod;
                //VocabularyFilterName?: String;
                //VocabularyName?: String;
                //Region?: TranscribeRegion;
            },
        },
    })
        .promise();
    return {};
};
exports.startTranscribe = startTranscribe;
/***
 * stop Transcribe.
 *
 */
const stopTranscribe = async (req) => {
    console.log("stopTranscribe");
    //// (1) If there is no meeting, return fail
    let meetingInfo = await (0, exports.getMeetingInfo)({ meetingName: req.meetingName });
    if (meetingInfo === null) {
        return {
            code: backend_request_1.BackendStopTranscribeExceptionType.NO_MEETING_FOUND,
            exception: true,
        };
    }
    //// (2) check if owner calls or not.
    var meetingMetadata = meetingInfo.metadata;
    var ownerId = meetingMetadata["OwnerId"];
    console.log("OWNERID", ownerId, "email", req.email);
    if (ownerId != req.email) {
        return {
            code: backend_request_1.BackendStopTranscribeExceptionType.NOT_OWNER,
            exception: true,
        };
    }
    //// (3) stop transcribe
    const res = await chime
        .stopMeetingTranscription({
        MeetingId: meetingInfo.meetingId,
    })
        .promise();
    console.log("stop transcribe result", res);
    return {};
};
exports.stopTranscribe = stopTranscribe;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVldGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xhbWJkYTIvbWVldGluZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBb0Q7QUFDcEQsK0JBQTBCO0FBQzFCLHVEQW9CMkI7QUFFM0IsaUNBQXVDO0FBQ3ZDLElBQUksZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQztBQUN2RCxJQUFJLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CLENBQUM7QUFDMUQsSUFBSSxHQUFHLEdBQUcsSUFBSSxrQkFBUSxFQUFFLENBQUM7QUFDekIsTUFBTSxLQUFLLEdBQUcsSUFBSSxlQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUNqRCxLQUFLLENBQUMsUUFBUSxHQUFHLElBQUksa0JBQVEsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO0FBQzlFOzs7Ozs7R0FNRztBQUNJLE1BQU0sY0FBYyxHQUFHLEtBQUssRUFBRSxHQUFpQyxFQUFpRCxFQUFFO0lBQ3JILHNCQUFzQjtJQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDeEMsTUFBTSxNQUFNLEdBQUcsTUFBTSxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFLEdBQUcsRUFBRSxFQUFFLFdBQVcsRUFBRSxFQUFFLENBQUMsRUFBRSxHQUFHLENBQUMsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDMUgsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFFL0IseUNBQXlDO0lBQ3pDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFO1FBQ2QsT0FBTyxJQUFJLENBQUM7S0FDZjtJQUVELHVFQUF1RTtJQUN2RSxNQUFNLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSyxDQUFDO0lBQ2pDLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0IsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUUsQ0FBQyxDQUFDO0lBQ3ZELE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0IsSUFBSTtRQUNBLGVBQWU7UUFDZixNQUFNLEdBQUcsR0FBRyxNQUFNLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxTQUFTLEVBQUUsV0FBVyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbkYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLENBQUMsQ0FBQztLQUMzQztJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM3QyxNQUFNLElBQUEscUJBQWEsRUFBQyxFQUFFLFdBQVcsRUFBRSxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUN0RCxPQUFPLElBQUksQ0FBQztLQUNmO0lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUUzQiw0QkFBNEI7SUFDNUIsT0FBTztRQUNILFdBQVcsRUFBRSxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUU7UUFDdkMsU0FBUyxFQUFFLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBRTtRQUNuQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUUsQ0FBQztRQUMzQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUUsQ0FBQztRQUM3QyxVQUFVLEVBQUUsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUc7UUFDcEUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxLQUFLLEtBQUssSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUUsQ0FBQyxDQUFDLE9BQU87S0FDckUsQ0FBQztBQUNOLENBQUMsQ0FBQztBQXBDVyxRQUFBLGNBQWMsa0JBb0N6QjtBQUVGOzs7R0FHRztBQUNJLE1BQU0sYUFBYSxHQUFHLEtBQUssRUFBRSxHQUFnQyxFQUFFLEVBQUU7SUFDcEUsTUFBTSxHQUFHO1NBQ0osVUFBVSxDQUFDO1FBQ1IsU0FBUyxFQUFFLGdCQUFnQjtRQUMzQixHQUFHLEVBQUU7WUFDRCxXQUFXLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLFdBQVcsRUFBRTtTQUN0QztLQUNKLENBQUM7U0FDRCxPQUFPLEVBQUUsQ0FBQztBQUNuQixDQUFDLENBQUM7QUFUVyxRQUFBLGFBQWEsaUJBU3hCO0FBRUssTUFBTSxhQUFhLEdBQUcsS0FBSyxFQUFFLEdBQWdDLEVBQXlDLEVBQUU7SUFDM0csaUNBQWlDO0lBQ2pDLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBQSxzQkFBYyxFQUFDLEVBQUUsV0FBVyxFQUFFLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQzNFLElBQUksV0FBVyxLQUFLLElBQUksRUFBRTtRQUN0QixPQUFPO1lBQ0gsT0FBTyxFQUFFLEtBQUs7WUFDZCxTQUFTLEVBQUUsV0FBVyxDQUFDLFNBQVM7WUFDaEMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxXQUFXO1lBQ3BDLE9BQU8sRUFBRSxXQUFXLENBQUMsUUFBUSxDQUFDLE9BQU87U0FDeEMsQ0FBQztLQUNMO0lBRUQsdUNBQXVDO0lBQ3ZDLE1BQU0sT0FBTyxHQUErQjtRQUN4QyxrQkFBa0IsRUFBRSxJQUFBLFNBQUUsR0FBRTtRQUN4QixXQUFXLEVBQUUsR0FBRyxDQUFDLE1BQU07S0FDMUIsQ0FBQztJQUNGLE1BQU0sY0FBYyxHQUFHLE1BQU0sS0FBSyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUVwRSxvQ0FBb0M7SUFDcEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUN4QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDM0IsTUFBTSxRQUFRLEdBQWE7UUFDdkIsT0FBTyxFQUFFLEdBQUcsQ0FBQyxLQUFLO1FBQ2xCLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtRQUNsQixTQUFTLEVBQUUsR0FBRztLQUNqQixDQUFDO0lBQ0YsTUFBTSxJQUFJLEdBQUc7UUFDVCxXQUFXLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLFdBQVcsRUFBRTtRQUNuQyxTQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsY0FBYyxDQUFDLE9BQVEsQ0FBQyxTQUFTLEVBQUU7UUFDbkQsT0FBTyxFQUFFLEVBQUUsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ3RELFFBQVEsRUFBRSxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1FBQ3pDLEdBQUcsRUFBRTtZQUNELENBQUMsRUFBRSxFQUFFLEdBQUcsSUFBQSxvQkFBYSxHQUFFO1NBQzFCO0tBQ0osQ0FBQztJQUNGLE1BQU0sR0FBRztTQUNKLE9BQU8sQ0FBQztRQUNMLFNBQVMsRUFBRSxnQkFBZ0I7UUFDM0IsSUFBSSxFQUFFLElBQUk7S0FDYixDQUFDO1NBQ0QsT0FBTyxFQUFFLENBQUM7SUFFZixPQUFPO1FBQ0gsT0FBTyxFQUFFLElBQUk7UUFDYixTQUFTLEVBQUUsY0FBYyxDQUFDLE9BQVEsQ0FBQyxTQUFVO1FBQzdDLFdBQVcsRUFBRSxHQUFHLENBQUMsV0FBVztRQUM1QixPQUFPLEVBQUUsR0FBRyxDQUFDLEtBQUs7S0FDckIsQ0FBQztBQUNOLENBQUMsQ0FBQztBQWpEVyxRQUFBLGFBQWEsaUJBaUR4QjtBQUVLLE1BQU0sV0FBVyxHQUFHLEtBQUssRUFBRSxHQUE4QixFQUFxRSxFQUFFO0lBQ25JLDZCQUE2QjtJQUM3QixJQUFJLFdBQVcsR0FBRyxNQUFNLElBQUEsc0JBQWMsRUFBQyxFQUFFLFdBQVcsRUFBRSxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztJQUN6RSxJQUFJLFdBQVcsS0FBSyxJQUFJLEVBQUU7UUFDdEIsT0FBTztZQUNILElBQUksRUFBRSxpREFBK0IsQ0FBQyxnQkFBZ0I7WUFDdEQsU0FBUyxFQUFFLElBQUk7U0FDbEIsQ0FBQztLQUNMO0lBRUQsMkJBQTJCO0lBQzNCLElBQUksR0FBRyxDQUFDLFlBQVksS0FBSyxFQUFFLEVBQUU7UUFDekIsT0FBTztZQUNILElBQUksRUFBRSxpREFBK0IsQ0FBQyxlQUFlO1lBQ3JELFNBQVMsRUFBRSxJQUFJO1NBQ2xCLENBQUM7S0FDTDtJQUVELHdDQUF3QztJQUN4QyxPQUFPLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFDcEMsTUFBTSxZQUFZLEdBQUcsTUFBTSxLQUFLO1NBQzNCLGNBQWMsQ0FBQztRQUNaLFNBQVMsRUFBRSxXQUFXLENBQUMsU0FBUztRQUNoQyxjQUFjLEVBQUUsSUFBQSxTQUFFLEdBQUU7S0FDdkIsQ0FBQztTQUNELE9BQU8sRUFBRSxDQUFDO0lBRWYsZ0NBQWdDO0lBQ2hDLE1BQU0sR0FBRztTQUNKLE9BQU8sQ0FBQztRQUNMLFNBQVMsRUFBRSxrQkFBa0I7UUFDN0IsSUFBSSxFQUFFO1lBQ0YsVUFBVSxFQUFFO2dCQUNSLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxXQUFXLElBQUksWUFBWSxDQUFDLFFBQVMsQ0FBQyxVQUFVLEVBQUU7YUFDL0Q7WUFDRCxZQUFZLEVBQUUsRUFBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUNyQyxHQUFHLEVBQUU7Z0JBQ0QsQ0FBQyxFQUFFLEVBQUUsR0FBRyxJQUFBLG9CQUFhLEdBQUU7YUFDMUI7U0FDSjtLQUNKLENBQUM7U0FDRCxPQUFPLEVBQUUsQ0FBQztJQUVmLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRXpDLE9BQU87UUFDSCxXQUFXLEVBQUUsV0FBVyxDQUFDLFdBQVc7UUFDcEMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxPQUFPO1FBQzVCLFFBQVEsRUFBRSxZQUFZLENBQUMsUUFBUztLQUNuQyxDQUFDO0FBQ04sQ0FBQyxDQUFDO0FBbERXLFFBQUEsV0FBVyxlQWtEdEI7QUFFSyxNQUFNLGVBQWUsR0FBRyxLQUFLLEVBQUUsR0FBa0MsRUFBNkUsRUFBRTtJQUNuSixrR0FBa0c7SUFDbEcsTUFBTSxNQUFNLEdBQUcsTUFBTSxHQUFHO1NBQ25CLE9BQU8sQ0FBQztRQUNMLFNBQVMsRUFBRSxrQkFBa0I7UUFDN0IsR0FBRyxFQUFFO1lBQ0QsVUFBVSxFQUFFO2dCQUNSLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxXQUFXLElBQUksR0FBRyxDQUFDLFVBQVUsRUFBRTthQUM1QztTQUNKO0tBQ0osQ0FBQztTQUNELE9BQU8sRUFBRSxDQUFDO0lBRWYsNERBQTREO0lBQzVELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFO1FBQ2QsT0FBTztZQUNILElBQUksRUFBRSxxREFBbUMsQ0FBQyxpQkFBaUI7WUFDM0QsU0FBUyxFQUFFLElBQUk7U0FDbEIsQ0FBQztLQUNMO0lBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUVwQiw4QkFBOEI7SUFDOUIsT0FBTztRQUNILFVBQVUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFFO1FBQ3JDLFlBQVksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFFO0tBQzVDLENBQUM7QUFDTixDQUFDLENBQUM7QUEzQlcsUUFBQSxlQUFlLG1CQTJCMUI7QUFFSyxNQUFNLGVBQWUsR0FBRyxLQUFLLEVBQUUsR0FBa0MsRUFBNkUsRUFBRTtJQUNuSiw2QkFBNkI7SUFDN0IsSUFBSSxXQUFXLEdBQUcsTUFBTSxJQUFBLHNCQUFjLEVBQUMsRUFBRSxXQUFXLEVBQUUsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFDekUsSUFBSSxXQUFXLEtBQUssSUFBSSxFQUFFO1FBQ3RCLE9BQU87WUFDSCxJQUFJLEVBQUUscURBQW1DLENBQUMsZ0JBQWdCO1lBQzFELFNBQVMsRUFBRSxJQUFJO1NBQ2xCLENBQUM7S0FDTDtJQUNELHFDQUFxQztJQUNyQyxJQUFJLGVBQWUsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDO0lBQzNDLElBQUksT0FBTyxHQUFHLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNwRCxJQUFJLE9BQU8sSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFO1FBQ3RCLE9BQU87WUFDSCxJQUFJLEVBQUUscURBQW1DLENBQUMsU0FBUztZQUNuRCxTQUFTLEVBQUUsSUFBSTtTQUNsQixDQUFDO0tBQ0w7SUFFRCx5QkFBeUI7SUFDekIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFDekMsTUFBTSxHQUFHLEdBQUcsTUFBTSxLQUFLO1NBQ2xCLHlCQUF5QixDQUFDO1FBQ3ZCLFNBQVMsRUFBRSxXQUFXLENBQUMsU0FBUztRQUNoQywwQkFBMEIsRUFBRTtZQUN4Qix3QkFBd0IsRUFBRTtnQkFDdEIsWUFBWSxFQUFFLEdBQUcsQ0FBQyxJQUFJO2dCQUN0Qiw0REFBNEQ7Z0JBQzVELGdDQUFnQztnQkFDaEMsMEJBQTBCO2dCQUMxQiw0QkFBNEI7YUFDL0I7U0FDSjtLQUNKLENBQUM7U0FDRCxPQUFPLEVBQUUsQ0FBQztJQUVmLE9BQU8sRUFBRSxDQUFDO0FBQ2QsQ0FBQyxDQUFDO0FBdENXLFFBQUEsZUFBZSxtQkFzQzFCO0FBRUY7OztHQUdHO0FBQ0ksTUFBTSxjQUFjLEdBQUcsS0FBSyxFQUFFLEdBQWlDLEVBQUUsRUFBRTtJQUN0RSxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDOUIsNENBQTRDO0lBQzVDLElBQUksV0FBVyxHQUFHLE1BQU0sSUFBQSxzQkFBYyxFQUFDLEVBQUUsV0FBVyxFQUFFLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQ3pFLElBQUksV0FBVyxLQUFLLElBQUksRUFBRTtRQUN0QixPQUFPO1lBQ0gsSUFBSSxFQUFFLG9EQUFrQyxDQUFDLGdCQUFnQjtZQUN6RCxTQUFTLEVBQUUsSUFBSTtTQUNsQixDQUFDO0tBQ0w7SUFFRCxxQ0FBcUM7SUFDckMsSUFBSSxlQUFlLEdBQUcsV0FBVyxDQUFDLFFBQVEsQ0FBQztJQUMzQyxJQUFJLE9BQU8sR0FBRyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDekMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEQsSUFBSSxPQUFPLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRTtRQUN0QixPQUFPO1lBQ0gsSUFBSSxFQUFFLG9EQUFrQyxDQUFDLFNBQVM7WUFDbEQsU0FBUyxFQUFFLElBQUk7U0FDbEIsQ0FBQztLQUNMO0lBRUQsd0JBQXdCO0lBQ3hCLE1BQU0sR0FBRyxHQUFHLE1BQU0sS0FBSztTQUNsQix3QkFBd0IsQ0FBQztRQUN0QixTQUFTLEVBQUUsV0FBVyxDQUFDLFNBQVM7S0FDbkMsQ0FBQztTQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUMzQyxPQUFPLEVBQUUsQ0FBQztBQUNkLENBQUMsQ0FBQztBQTlCVyxRQUFBLGNBQWMsa0JBOEJ6QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER5bmFtb0RCLCBDaGltZSwgRW5kcG9pbnQgfSBmcm9tIFwiYXdzLXNka1wiO1xuaW1wb3J0IHsgdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0IHtcbiAgICBCYWNrZW5kQ3JlYXRlTWVldGluZ1JlcXVlc3QsXG4gICAgQmFja2VuZENyZWF0ZU1lZXRpbmdSZXNwb25zZSxcbiAgICBCYWNrZW5kRGVsZXRlTWVldGluZ1JlcXVlc3QsXG4gICAgQmFja2VuZEdldEF0dGVuZGVlSW5mb0V4Y2VwdGlvbixcbiAgICBCYWNrZW5kR2V0QXR0ZW5kZWVJbmZvRXhjZXB0aW9uVHlwZSxcbiAgICBCYWNrZW5kR2V0QXR0ZW5kZWVJbmZvUmVxdWVzdCxcbiAgICBCYWNrZW5kR2V0QXR0ZW5kZWVJbmZvUmVzcG9uc2UsXG4gICAgQmFja2VuZEdldE1lZXRpbmdJbmZvUmVxdWVzdCxcbiAgICBCYWNrZW5kR2V0TWVldGluZ0luZm9SZXNwb25zZSxcbiAgICBCYWNrZW5kSm9pbk1lZXRpbmdFeGNlcHRpb24sXG4gICAgQmFja2VuZEpvaW5NZWV0aW5nRXhjZXB0aW9uVHlwZSxcbiAgICBCYWNrZW5kSm9pbk1lZXRpbmdSZXF1ZXN0LFxuICAgIEJhY2tlbmRKb2luTWVldGluZ1Jlc3BvbnNlLFxuICAgIEJhY2tlbmRTdGFydFRyYW5zY3JpYmVFeGNlcHRpb24sXG4gICAgQmFja2VuZFN0YXJ0VHJhbnNjcmliZUV4Y2VwdGlvblR5cGUsXG4gICAgQmFja2VuZFN0YXJ0VHJhbnNjcmliZVJlcXVlc3QsXG4gICAgQmFja2VuZFN0YXJ0VHJhbnNjcmliZVJlc3BvbnNlLFxuICAgIEJhY2tlbmRTdG9wVHJhbnNjcmliZUV4Y2VwdGlvblR5cGUsXG4gICAgQmFja2VuZFN0b3BUcmFuc2NyaWJlUmVxdWVzdCxcbn0gZnJvbSBcIi4vYmFja2VuZF9yZXF1ZXN0XCI7XG5pbXBvcnQgeyBNZXRhZGF0YSB9IGZyb20gXCIuL2h0dHBfcmVxdWVzdFwiO1xuaW1wb3J0IHsgZ2V0RXhwaXJlRGF0ZSB9IGZyb20gXCIuL3V0aWxcIjtcbnZhciBtZWV0aW5nVGFibGVOYW1lID0gcHJvY2Vzcy5lbnYuTUVFVElOR19UQUJMRV9OQU1FITtcbnZhciBhdHRlbmRlZXNUYWJsZU5hbWUgPSBwcm9jZXNzLmVudi5BVFRFTkRFRV9UQUJMRV9OQU1FITtcbnZhciBkZGIgPSBuZXcgRHluYW1vREIoKTtcbmNvbnN0IGNoaW1lID0gbmV3IENoaW1lKHsgcmVnaW9uOiBcInVzLWVhc3QtMVwiIH0pO1xuY2hpbWUuZW5kcG9pbnQgPSBuZXcgRW5kcG9pbnQoXCJodHRwczovL3NlcnZpY2UuY2hpbWUuYXdzLmFtYXpvbi5jb20vY29uc29sZVwiKTtcbi8qKlxuICogZ2V0IG1lZXRpbmcgaW5mb1xuICogKDEpIHJldHJpZXZlIG1lZXRpbmcgaW5mbyBmcm9tIERCXG4gKiAoMikgSWYgdGhlcmUgaXMgbm8gbWVldGluZyBpbiBEQiwgcmV0dXJuIG51bGxcbiAqICgzKSBJZiB0aGVyZSBpcyBubyBtZWV0aW5nIGluIEFtYXpvbiBDaGltZSwgZGVsZXRlIGZyb20gREIgYW5kIHJldHVybiBudWxsLlxuICogQHBhcmFtIHsqfSBtZWV0aW5nTmFtZVxuICovXG5leHBvcnQgY29uc3QgZ2V0TWVldGluZ0luZm8gPSBhc3luYyAocmVxOiBCYWNrZW5kR2V0TWVldGluZ0luZm9SZXF1ZXN0KTogUHJvbWlzZTxCYWNrZW5kR2V0TWVldGluZ0luZm9SZXNwb25zZSB8IG51bGw+ID0+IHtcbiAgICAvLy8vICgxKSByZXRyaWV2ZSBpbmZvXG4gICAgY29uc29sZS5sb2coXCJkeW5hbW8xXCIsIHJlcS5tZWV0aW5nTmFtZSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGRiLmdldEl0ZW0oeyBUYWJsZU5hbWU6IG1lZXRpbmdUYWJsZU5hbWUsIEtleTogeyBNZWV0aW5nTmFtZTogeyBTOiByZXEubWVldGluZ05hbWUgfSB9IH0pLnByb21pc2UoKTtcbiAgICBjb25zb2xlLmxvZyhcImR5bmFtbzJcIiwgcmVzdWx0KTtcblxuICAgIC8vLy8gKDIpIElmIG5vIG1lZXRpbmcgaW4gREIsIHJldHVybiBudWxsXG4gICAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLy8vICgzKSBJZiBubyBtZWV0aW5nIGluIENoaW1lLCBkZWxldGUgbWVldGluZyBmcm9tIERCIGFuZCByZXR1cm4gbnVsbFxuICAgIGNvbnN0IG1lZXRpbmdJbmZvID0gcmVzdWx0Lkl0ZW0hO1xuICAgIGNvbnNvbGUubG9nKFwiUkVBRCBQUk9QUjFcIik7XG4gICAgY29uc3QgbWVldGluZ0RhdGEgPSBKU09OLnBhcnNlKG1lZXRpbmdJbmZvLk1lZXRpbmcuUyEpO1xuICAgIGNvbnNvbGUubG9nKFwiUkVBRCBQUk9QUjJcIik7XG4gICAgdHJ5IHtcbiAgICAgICAgLy8gQ2hlY2sgRXhpc3Q/XG4gICAgICAgIGNvbnN0IG1pZCA9IGF3YWl0IGNoaW1lLmdldE1lZXRpbmcoeyBNZWV0aW5nSWQ6IG1lZXRpbmdEYXRhLk1lZXRpbmdJZCB9KS5wcm9taXNlKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2hpbWUgbWVldGluZyBpbmZvOlwiLCBtaWQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZyhcImNoaW1lIG1lZXRpbmcgZXhjZXB0aW9uOlwiLCBlcnIpO1xuICAgICAgICBhd2FpdCBkZWxldGVNZWV0aW5nKHsgbWVldGluZ05hbWU6IHJlcS5tZWV0aW5nTmFtZSB9KTtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnNvbGUubG9nKFwiUkVBRCBQUk9QUjNcIik7XG5cbiAgICAvLy8vICg0KSByZXR1cm4gbWVldGluZyBpbmZvXG4gICAgcmV0dXJuIHtcbiAgICAgICAgbWVldGluZ05hbWU6IG1lZXRpbmdJbmZvLk1lZXRpbmdOYW1lLlMhLFxuICAgICAgICBtZWV0aW5nSWQ6IG1lZXRpbmdJbmZvLk1lZXRpbmdJZC5TISxcbiAgICAgICAgbWVldGluZzogSlNPTi5wYXJzZShtZWV0aW5nSW5mby5NZWV0aW5nLlMhKSxcbiAgICAgICAgbWV0YWRhdGE6IEpTT04ucGFyc2UobWVldGluZ0luZm8uTWV0YWRhdGEuUyEpLFxuICAgICAgICBobW1UYXNrQXJuOiBtZWV0aW5nSW5mby5IbW1UYXNrQXJuID8gbWVldGluZ0luZm8uSG1tVGFza0Fybi5TISA6IFwiLVwiLFxuICAgICAgICBpc093bmVyOiByZXEuZW1haWwgPT09IEpTT04ucGFyc2UobWVldGluZ0luZm8uTWV0YWRhdGEuUyEpLk93bmVySWQsXG4gICAgfTtcbn07XG5cbi8qKlxuICogRGVsZXRlIG1lZXRpbmcgZnJvbSBEQlxuICogQHBhcmFtIHsqfSBtZWV0aW5nTmFtZVxuICovXG5leHBvcnQgY29uc3QgZGVsZXRlTWVldGluZyA9IGFzeW5jIChyZXE6IEJhY2tlbmREZWxldGVNZWV0aW5nUmVxdWVzdCkgPT4ge1xuICAgIGF3YWl0IGRkYlxuICAgICAgICAuZGVsZXRlSXRlbSh7XG4gICAgICAgICAgICBUYWJsZU5hbWU6IG1lZXRpbmdUYWJsZU5hbWUsXG4gICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgICBNZWV0aW5nTmFtZTogeyBTOiByZXEubWVldGluZ05hbWUgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgICAgIC5wcm9taXNlKCk7XG59O1xuXG5leHBvcnQgY29uc3QgY3JlYXRlTWVldGluZyA9IGFzeW5jIChyZXE6IEJhY2tlbmRDcmVhdGVNZWV0aW5nUmVxdWVzdCk6IFByb21pc2U8QmFja2VuZENyZWF0ZU1lZXRpbmdSZXNwb25zZT4gPT4ge1xuICAgIC8vLy8gKDEpIGNoZWNrIG1lZXRpbmcgbmFtZSBleGlzdFxuICAgIGNvbnN0IG1lZXRpbmdJbmZvID0gYXdhaXQgZ2V0TWVldGluZ0luZm8oeyBtZWV0aW5nTmFtZTogcmVxLm1lZXRpbmdOYW1lIH0pO1xuICAgIGlmIChtZWV0aW5nSW5mbyAhPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY3JlYXRlZDogZmFsc2UsXG4gICAgICAgICAgICBtZWV0aW5nSWQ6IG1lZXRpbmdJbmZvLm1lZXRpbmdJZCxcbiAgICAgICAgICAgIG1lZXRpbmdOYW1lOiBtZWV0aW5nSW5mby5tZWV0aW5nTmFtZSxcbiAgICAgICAgICAgIG93bmVySWQ6IG1lZXRpbmdJbmZvLm1ldGFkYXRhLk93bmVySWQsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8vLyAoMikgY3JlYXRlIG1lZXRpbmcgaW4gQW1hem9uIENoaW1lXG4gICAgY29uc3QgcmVxdWVzdDogQ2hpbWUuQ3JlYXRlTWVldGluZ1JlcXVlc3QgPSB7XG4gICAgICAgIENsaWVudFJlcXVlc3RUb2tlbjogdjQoKSxcbiAgICAgICAgTWVkaWFSZWdpb246IHJlcS5yZWdpb24sXG4gICAgfTtcbiAgICBjb25zdCBuZXdNZWV0aW5nSW5mbyA9IGF3YWl0IGNoaW1lLmNyZWF0ZU1lZXRpbmcocmVxdWVzdCkucHJvbWlzZSgpO1xuXG4gICAgLy8vLyAoMykgcmVnaXN0ZXIgbWVldGluZyBpbmZvIGluIERCXG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3Qgbm93ID0gZGF0ZS5nZXRUaW1lKCk7XG4gICAgY29uc3QgbWV0YWRhdGE6IE1ldGFkYXRhID0ge1xuICAgICAgICBPd25lcklkOiByZXEuZW1haWwsXG4gICAgICAgIFJlZ2lvbjogcmVxLnJlZ2lvbixcbiAgICAgICAgU3RhcnRUaW1lOiBub3csXG4gICAgfTtcbiAgICBjb25zdCBpdGVtID0ge1xuICAgICAgICBNZWV0aW5nTmFtZTogeyBTOiByZXEubWVldGluZ05hbWUgfSxcbiAgICAgICAgTWVldGluZ0lkOiB7IFM6IG5ld01lZXRpbmdJbmZvLk1lZXRpbmchLk1lZXRpbmdJZCB9LFxuICAgICAgICBNZWV0aW5nOiB7IFM6IEpTT04uc3RyaW5naWZ5KG5ld01lZXRpbmdJbmZvLk1lZXRpbmcpIH0sXG4gICAgICAgIE1ldGFkYXRhOiB7IFM6IEpTT04uc3RyaW5naWZ5KG1ldGFkYXRhKSB9LFxuICAgICAgICBUVEw6IHtcbiAgICAgICAgICAgIE46IFwiXCIgKyBnZXRFeHBpcmVEYXRlKCksXG4gICAgICAgIH0sXG4gICAgfTtcbiAgICBhd2FpdCBkZGJcbiAgICAgICAgLnB1dEl0ZW0oe1xuICAgICAgICAgICAgVGFibGVOYW1lOiBtZWV0aW5nVGFibGVOYW1lLFxuICAgICAgICAgICAgSXRlbTogaXRlbSxcbiAgICAgICAgfSlcbiAgICAgICAgLnByb21pc2UoKTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIGNyZWF0ZWQ6IHRydWUsXG4gICAgICAgIG1lZXRpbmdJZDogbmV3TWVldGluZ0luZm8uTWVldGluZyEuTWVldGluZ0lkISxcbiAgICAgICAgbWVldGluZ05hbWU6IHJlcS5tZWV0aW5nTmFtZSxcbiAgICAgICAgb3duZXJJZDogcmVxLmVtYWlsLFxuICAgIH07XG59O1xuXG5leHBvcnQgY29uc3Qgam9pbk1lZXRpbmcgPSBhc3luYyAocmVxOiBCYWNrZW5kSm9pbk1lZXRpbmdSZXF1ZXN0KTogUHJvbWlzZTxCYWNrZW5kSm9pbk1lZXRpbmdSZXNwb25zZSB8IEJhY2tlbmRKb2luTWVldGluZ0V4Y2VwdGlvbj4gPT4ge1xuICAgIC8vLy8gKDEpIGNoZWNrIG1lZXRpbmcgZXhpc3RzXG4gICAgbGV0IG1lZXRpbmdJbmZvID0gYXdhaXQgZ2V0TWVldGluZ0luZm8oeyBtZWV0aW5nTmFtZTogcmVxLm1lZXRpbmdOYW1lIH0pO1xuICAgIGlmIChtZWV0aW5nSW5mbyA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29kZTogQmFja2VuZEpvaW5NZWV0aW5nRXhjZXB0aW9uVHlwZS5OT19NRUVUSU5HX0ZPVU5ELFxuICAgICAgICAgICAgZXhjZXB0aW9uOiB0cnVlLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIC8vLy8gKDIpIGNoZWNrIGF0dGVuZGVlTmFtZVxuICAgIGlmIChyZXEuYXR0ZW5kZWVOYW1lID09PSBcIlwiKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBjb2RlOiBCYWNrZW5kSm9pbk1lZXRpbmdFeGNlcHRpb25UeXBlLlBBUkFNRVRFUl9FUlJPUixcbiAgICAgICAgICAgIGV4Y2VwdGlvbjogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLy8vICgzKSBjcmVhdGUgYXR0ZW5kZWUgaW4gQW1hem9uIENoaW1lXG4gICAgY29uc29sZS5pbmZvKFwiQWRkaW5nIG5ldyBhdHRlbmRlZVwiKTtcbiAgICBjb25zdCBhdHRlbmRlZUluZm8gPSBhd2FpdCBjaGltZVxuICAgICAgICAuY3JlYXRlQXR0ZW5kZWUoe1xuICAgICAgICAgICAgTWVldGluZ0lkOiBtZWV0aW5nSW5mby5tZWV0aW5nSWQsXG4gICAgICAgICAgICBFeHRlcm5hbFVzZXJJZDogdjQoKSxcbiAgICAgICAgfSlcbiAgICAgICAgLnByb21pc2UoKTtcblxuICAgIC8vLy8gKDQpIHJlZ2lzdGVyIGF0dGVuZGVlIGluIERCXG4gICAgYXdhaXQgZGRiXG4gICAgICAgIC5wdXRJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogYXR0ZW5kZWVzVGFibGVOYW1lLFxuICAgICAgICAgICAgSXRlbToge1xuICAgICAgICAgICAgICAgIEF0dGVuZGVlSWQ6IHtcbiAgICAgICAgICAgICAgICAgICAgUzogYCR7cmVxLm1lZXRpbmdOYW1lfS8ke2F0dGVuZGVlSW5mby5BdHRlbmRlZSEuQXR0ZW5kZWVJZH1gLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgQXR0ZW5kZWVOYW1lOiB7IFM6IHJlcS5hdHRlbmRlZU5hbWUgfSxcbiAgICAgICAgICAgICAgICBUVEw6IHtcbiAgICAgICAgICAgICAgICAgICAgTjogXCJcIiArIGdldEV4cGlyZURhdGUoKSxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgICAgLnByb21pc2UoKTtcblxuICAgIGNvbnNvbGUubG9nKFwiTUVFVElOR19JTkZPXCIsIG1lZXRpbmdJbmZvKTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIG1lZXRpbmdOYW1lOiBtZWV0aW5nSW5mby5tZWV0aW5nTmFtZSxcbiAgICAgICAgbWVldGluZzogbWVldGluZ0luZm8ubWVldGluZyxcbiAgICAgICAgYXR0ZW5kZWU6IGF0dGVuZGVlSW5mby5BdHRlbmRlZSEsXG4gICAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRBdHRlbmRlZUluZm8gPSBhc3luYyAocmVxOiBCYWNrZW5kR2V0QXR0ZW5kZWVJbmZvUmVxdWVzdCk6IFByb21pc2U8QmFja2VuZEdldEF0dGVuZGVlSW5mb1Jlc3BvbnNlIHwgQmFja2VuZEdldEF0dGVuZGVlSW5mb0V4Y2VwdGlvbj4gPT4ge1xuICAgIC8vLy8gKDEpIHJldHJpZXZlIGF0dGVuZGVlIGluZm8gZnJvbSBEQi4ga2V5IGlzIGNvbmNhdGluYXRlIG9mIG1lZXRpbmdOYW1lKGVuY29kZWQpIGFuZCBhdHRlbmRlZUlkXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGRiXG4gICAgICAgIC5nZXRJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogYXR0ZW5kZWVzVGFibGVOYW1lLFxuICAgICAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICAgICAgQXR0ZW5kZWVJZDoge1xuICAgICAgICAgICAgICAgICAgICBTOiBgJHtyZXEubWVldGluZ05hbWV9LyR7cmVxLmF0dGVuZGVlSWR9YCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgICAgLnByb21pc2UoKTtcblxuICAgIC8vLy8gKDIpIElmIHRoZXJlIGlzIG5vIGF0dGVuZGVlIGluIHRoZSBtZWV0aW5nLCByZXR1cm4gZmFpbFxuICAgIGlmICghcmVzdWx0Lkl0ZW0pIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvZGU6IEJhY2tlbmRHZXRBdHRlbmRlZUluZm9FeGNlcHRpb25UeXBlLk5PX0FUVEVOREVFX0ZPVU5ELFxuICAgICAgICAgICAgZXhjZXB0aW9uOiB0cnVlLFxuICAgICAgICB9O1xuICAgIH1cbiAgICBjb25zb2xlLmxvZyhyZXN1bHQpO1xuXG4gICAgLy8vLyAoMykgcmV0dXJuIGF0dGVuZGVlIGluZm8uXG4gICAgcmV0dXJuIHtcbiAgICAgICAgYXR0ZW5kZWVJZDogcmVzdWx0Lkl0ZW0uQXR0ZW5kZWVJZC5TISxcbiAgICAgICAgYXR0ZW5kZWVOYW1lOiByZXN1bHQuSXRlbS5BdHRlbmRlZU5hbWUuUyEsXG4gICAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBzdGFydFRyYW5zY3JpYmUgPSBhc3luYyAocmVxOiBCYWNrZW5kU3RhcnRUcmFuc2NyaWJlUmVxdWVzdCk6IFByb21pc2U8QmFja2VuZFN0YXJ0VHJhbnNjcmliZVJlc3BvbnNlIHwgQmFja2VuZFN0YXJ0VHJhbnNjcmliZUV4Y2VwdGlvbj4gPT4ge1xuICAgIC8vLy8gKDEpIGNoZWNrIG1lZXRpbmcgZXhpc3RzXG4gICAgbGV0IG1lZXRpbmdJbmZvID0gYXdhaXQgZ2V0TWVldGluZ0luZm8oeyBtZWV0aW5nTmFtZTogcmVxLm1lZXRpbmdOYW1lIH0pO1xuICAgIGlmIChtZWV0aW5nSW5mbyA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29kZTogQmFja2VuZFN0YXJ0VHJhbnNjcmliZUV4Y2VwdGlvblR5cGUuTk9fTUVFVElOR19GT1VORCxcbiAgICAgICAgICAgIGV4Y2VwdGlvbjogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgLy8vLyAoMikgY2hlY2sgaWYgb3duZXIgY2FsbHMgb3Igbm90LlxuICAgIHZhciBtZWV0aW5nTWV0YWRhdGEgPSBtZWV0aW5nSW5mby5tZXRhZGF0YTtcbiAgICB2YXIgb3duZXJJZCA9IG1lZXRpbmdNZXRhZGF0YVtcIk93bmVySWRcIl07XG4gICAgY29uc29sZS5sb2coXCJPV05FUklEXCIsIG93bmVySWQsIFwiZW1haWxcIiwgcmVxLmVtYWlsKTtcbiAgICBpZiAob3duZXJJZCAhPSByZXEuZW1haWwpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvZGU6IEJhY2tlbmRTdGFydFRyYW5zY3JpYmVFeGNlcHRpb25UeXBlLk5PVF9PV05FUixcbiAgICAgICAgICAgIGV4Y2VwdGlvbjogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLy8vICgzKSBzdGFydCB0cmFuc2NyaWJlXG4gICAgY29uc29sZS5sb2coYExhbmdhZ2UgY29kZSA6JHtyZXEubGFuZ31gKTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBjaGltZVxuICAgICAgICAuc3RhcnRNZWV0aW5nVHJhbnNjcmlwdGlvbih7XG4gICAgICAgICAgICBNZWV0aW5nSWQ6IG1lZXRpbmdJbmZvLm1lZXRpbmdJZCxcbiAgICAgICAgICAgIFRyYW5zY3JpcHRpb25Db25maWd1cmF0aW9uOiB7XG4gICAgICAgICAgICAgICAgRW5naW5lVHJhbnNjcmliZVNldHRpbmdzOiB7XG4gICAgICAgICAgICAgICAgICAgIExhbmd1YWdlQ29kZTogcmVxLmxhbmcsXG4gICAgICAgICAgICAgICAgICAgIC8vVm9jYWJ1bGFyeUZpbHRlck1ldGhvZD86IFRyYW5zY3JpYmVWb2NhYnVsYXJ5RmlsdGVyTWV0aG9kO1xuICAgICAgICAgICAgICAgICAgICAvL1ZvY2FidWxhcnlGaWx0ZXJOYW1lPzogU3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAvL1ZvY2FidWxhcnlOYW1lPzogU3RyaW5nO1xuICAgICAgICAgICAgICAgICAgICAvL1JlZ2lvbj86IFRyYW5zY3JpYmVSZWdpb247XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgICAgIC5wcm9taXNlKCk7XG5cbiAgICByZXR1cm4ge307XG59O1xuXG4vKioqXG4gKiBzdG9wIFRyYW5zY3JpYmUuXG4gKlxuICovXG5leHBvcnQgY29uc3Qgc3RvcFRyYW5zY3JpYmUgPSBhc3luYyAocmVxOiBCYWNrZW5kU3RvcFRyYW5zY3JpYmVSZXF1ZXN0KSA9PiB7XG4gICAgY29uc29sZS5sb2coXCJzdG9wVHJhbnNjcmliZVwiKTtcbiAgICAvLy8vICgxKSBJZiB0aGVyZSBpcyBubyBtZWV0aW5nLCByZXR1cm4gZmFpbFxuICAgIGxldCBtZWV0aW5nSW5mbyA9IGF3YWl0IGdldE1lZXRpbmdJbmZvKHsgbWVldGluZ05hbWU6IHJlcS5tZWV0aW5nTmFtZSB9KTtcbiAgICBpZiAobWVldGluZ0luZm8gPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGNvZGU6IEJhY2tlbmRTdG9wVHJhbnNjcmliZUV4Y2VwdGlvblR5cGUuTk9fTUVFVElOR19GT1VORCxcbiAgICAgICAgICAgIGV4Y2VwdGlvbjogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLy8vICgyKSBjaGVjayBpZiBvd25lciBjYWxscyBvciBub3QuXG4gICAgdmFyIG1lZXRpbmdNZXRhZGF0YSA9IG1lZXRpbmdJbmZvLm1ldGFkYXRhO1xuICAgIHZhciBvd25lcklkID0gbWVldGluZ01ldGFkYXRhW1wiT3duZXJJZFwiXTtcbiAgICBjb25zb2xlLmxvZyhcIk9XTkVSSURcIiwgb3duZXJJZCwgXCJlbWFpbFwiLCByZXEuZW1haWwpO1xuICAgIGlmIChvd25lcklkICE9IHJlcS5lbWFpbCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29kZTogQmFja2VuZFN0b3BUcmFuc2NyaWJlRXhjZXB0aW9uVHlwZS5OT1RfT1dORVIsXG4gICAgICAgICAgICBleGNlcHRpb246IHRydWUsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8vLyAoMykgc3RvcCB0cmFuc2NyaWJlXG4gICAgY29uc3QgcmVzID0gYXdhaXQgY2hpbWVcbiAgICAgICAgLnN0b3BNZWV0aW5nVHJhbnNjcmlwdGlvbih7XG4gICAgICAgICAgICBNZWV0aW5nSWQ6IG1lZXRpbmdJbmZvLm1lZXRpbmdJZCxcbiAgICAgICAgfSlcbiAgICAgICAgLnByb21pc2UoKTtcbiAgICBjb25zb2xlLmxvZyhcInN0b3AgdHJhbnNjcmliZSByZXN1bHRcIiwgcmVzKTtcbiAgICByZXR1cm4ge307XG59O1xuIl19