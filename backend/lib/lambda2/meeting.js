"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAttendeeInfo = exports.joinMeeting = exports.createMeeting = exports.deleteMeeting = exports.getMeetingInfo = void 0;
const aws_sdk_1 = require("aws-sdk");
const uuid_1 = require("uuid");
const const_1 = require("./const");
const util_1 = require("./util");
var meetingTableName = process.env.MEETING_TABLE_NAME;
var attendeesTableName = process.env.ATTENDEE_TABLE_NAME;
var ddb = new aws_sdk_1.DynamoDB();
const chime = new aws_sdk_1.Chime({ region: "us-east-1" });
chime.endpoint = new aws_sdk_1.Endpoint("https://service.chime.aws.amazon.com/console");
/**
 * get meeting info
 * (1) retrieve meeting info from DB
 * (2) If there is no meeting in DB, return null
 * (3) If there is no meeting in Amazon Chime, delete from DB and return null.
 * @param {*} meetingName
 */
const getMeetingInfo = async (meetingName) => {
    //// (1) retrieve info
    console.log("dynamo1", meetingName);
    const result = await ddb.getItem({ TableName: meetingTableName, Key: { MeetingName: { S: meetingName } } }).promise();
    console.log("dynamo2", result);
    //// (2) If no meeting in DB, return null
    if (!result.Item) {
        return null;
    }
    //// (3) If no meeting in Chime, delete meeting from DB and return null
    const meetingInfo = result.Item;
    console.log("READ PROPR1");
    const meetingData = JSON.parse(meetingInfo.Meeting.S);
    console.log("READ PROPR2");
    try {
        // Check Exist?
        const mid = await chime.getMeeting({ MeetingId: meetingData.MeetingId }).promise();
        console.log("chime meeting info:", mid);
    }
    catch (err) {
        console.log("chime meeting exception:", err);
        await (0, exports.deleteMeeting)(meetingName);
        return null;
    }
    console.log("READ PROPR3");
    //// (4) return meeting info
    return {
        meetingName: meetingInfo.MeetingName.S,
        meetingId: meetingInfo.MeetingId.S,
        meeting: JSON.parse(meetingInfo.Meeting.S),
        metadata: JSON.parse(meetingInfo.Metadata.S),
        hmmTaskArn: meetingInfo.HmmTaskArn ? meetingInfo.HmmTaskArn.S : "-",
    };
};
exports.getMeetingInfo = getMeetingInfo;
/**
 * Delete meeting from DB
 * @param {*} meetingName
 */
const deleteMeeting = async (meetingName) => {
    await ddb
        .deleteItem({
        TableName: meetingTableName,
        Key: {
            MeetingName: { S: meetingName },
        },
    })
        .promise();
};
exports.deleteMeeting = deleteMeeting;
const createMeeting = async (email, meetingName, region) => {
    //// (1) check meeting name exist
    const meetingInfo = await (0, exports.getMeetingInfo)(meetingName);
    if (meetingInfo !== null) {
        return {
            created: false,
            meetingId: meetingInfo.meetingId,
            meetingName: meetingInfo.meetingName,
            ownerId: meetingInfo.metadata.OwnerId,
        };
    }
    //// (2) create meeting in Amazon Chime
    const request = {
        ClientRequestToken: (0, uuid_1.v4)(),
        MediaRegion: region,
    };
    const newMeetingInfo = await chime.createMeeting(request).promise();
    //// (3) register meeting info in DB
    const date = new Date();
    const now = date.getTime();
    const metadata = {
        OwnerId: email,
        Region: region,
        StartTime: now,
    };
    const item = {
        MeetingName: { S: meetingName },
        MeetingId: { S: newMeetingInfo.Meeting.MeetingId },
        Meeting: { S: JSON.stringify(newMeetingInfo.Meeting) },
        Metadata: { S: JSON.stringify(metadata) },
        TTL: {
            N: "" + (0, util_1.getExpireDate)(),
        },
    };
    await ddb
        .putItem({
        TableName: meetingTableName,
        Item: item,
    })
        .promise();
    return {
        created: true,
        meetingId: newMeetingInfo.Meeting.MeetingId,
        meetingName: meetingName,
        ownerId: email,
    };
};
exports.createMeeting = createMeeting;
const joinMeeting = async (meetingName, attendeeName) => {
    //// (1) check meeting exists
    let meetingInfo = await (0, exports.getMeetingInfo)(meetingName);
    if (meetingInfo === null) {
        return {
            code: const_1.JoinMeetingExceptionType.NO_MEETING_FOUND,
            exception: true,
        };
    }
    //// (2) check attendeeName
    if (attendeeName === "") {
        return {
            code: const_1.JoinMeetingExceptionType.PARAMETER_ERROR,
            exception: true,
        };
    }
    //// (3) create attendee in Amazon Chime
    console.info("Adding new attendee");
    const attendeeInfo = await chime
        .createAttendee({
        MeetingId: meetingInfo.meetingId,
        ExternalUserId: (0, uuid_1.v4)(),
    })
        .promise();
    //// (4) register attendee in DB
    await ddb
        .putItem({
        TableName: attendeesTableName,
        Item: {
            AttendeeId: {
                S: `${meetingName}/${attendeeInfo.Attendee.AttendeeId}`,
            },
            AttendeeName: { S: attendeeName },
            TTL: {
                N: "" + (0, util_1.getExpireDate)(),
            },
        },
    })
        .promise();
    console.log("MEETING_INFO", meetingInfo);
    return {
        meetingName: meetingInfo.meetingName,
        meeting: meetingInfo.meeting,
        attendee: attendeeInfo.Attendee,
    };
};
exports.joinMeeting = joinMeeting;
const getAttendeeInfo = async (meetingName, attendeeId) => {
    //// (1) retrieve attendee info from DB. key is concatinate of meetingName(encoded) and attendeeId
    const result = await ddb
        .getItem({
        TableName: attendeesTableName,
        Key: {
            AttendeeId: {
                S: `${meetingName}/${attendeeId}`,
            },
        },
    })
        .promise();
    //// (2) If there is no attendee in the meeting, return fail
    if (!result.Item) {
        return {
            code: const_1.GetAttendeeInfoExceptionType.NO_ATTENDEE_FOUND,
            exception: true,
        };
    }
    console.log(result);
    //// (3) return attendee info.
    return {
        attendeeId: result.Item.AttendeeId.S,
        attendeeName: result.Item.AttendeeName.S,
    };
};
exports.getAttendeeInfo = getAttendeeInfo;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVldGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1lZXRpbmcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQW9EO0FBQ3BELCtCQUEwQjtBQUMxQixtQ0FBNk47QUFDN04saUNBQXVDO0FBQ3ZDLElBQUksZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQztBQUN2RCxJQUFJLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CLENBQUM7QUFDMUQsSUFBSSxHQUFHLEdBQUcsSUFBSSxrQkFBUSxFQUFFLENBQUM7QUFDekIsTUFBTSxLQUFLLEdBQUcsSUFBSSxlQUFLLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQUNqRCxLQUFLLENBQUMsUUFBUSxHQUFHLElBQUksa0JBQVEsQ0FBQyw4Q0FBOEMsQ0FBQyxDQUFDO0FBQzlFOzs7Ozs7R0FNRztBQUNJLE1BQU0sY0FBYyxHQUFHLEtBQUssRUFBRSxXQUFtQixFQUErQixFQUFFO0lBQ3JGLHNCQUFzQjtJQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNwQyxNQUFNLE1BQU0sR0FBRyxNQUFNLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFLEVBQUUsV0FBVyxFQUFFLEVBQUUsQ0FBQyxFQUFFLFdBQVcsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3RILE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBRS9CLHlDQUF5QztJQUN6QyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTtRQUNkLE9BQU8sSUFBSSxDQUFDO0tBQ2Y7SUFFRCx1RUFBdUU7SUFDdkUsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLElBQUssQ0FBQztJQUNq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QUM7UUFDTCxTQUFTLEVBQUUsa0JBQWtCO1FBQzdCLEdBQUcsRUFBRTtZQUNELFVBQVUsRUFBRTtnQkFDUixDQUFDLEVBQUUsR0FBRyxXQUFXLElBQUksVUFBVSxFQUFFO2FBQ3BDO1NBQ0o7S0FDSixDQUFDO1NBQ0QsT0FBTyxFQUFFLENBQUM7SUFFZiw0REFBNEQ7SUFDNUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUU7UUFDZCxPQUFPO1lBQ0gsSUFBSSxFQUFFLG9DQUE0QixDQUFDLGlCQUFpQjtZQUNwRCxTQUFTLEVBQUUsSUFBSTtTQUNsQixDQUFDO0tBQ0w7SUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXBCLDhCQUE4QjtJQUM5QixPQUFPO1FBQ0gsVUFBVSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUU7UUFDckMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUU7S0FDNUMsQ0FBQztBQUNOLENBQUMsQ0FBQztBQTNCVyxRQUFBLGVBQWUsbUJBMkIxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER5bmFtb0RCLCBDaGltZSwgRW5kcG9pbnQgfSBmcm9tIFwiYXdzLXNka1wiO1xuaW1wb3J0IHsgdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0IHsgQ3JlYXRlTWVldGluZ1Jlc3BvbnNlLCBHZXRBdHRlbmRlZUluZm9FeGNlcHRpb24sIEdldEF0dGVuZGVlSW5mb0V4Y2VwdGlvblR5cGUsIEdldEF0dGVuZGVlSW5mb1Jlc3BvbnNlLCBKb2luTWVldGluZ0V4Y2VwdGlvbiwgSm9pbk1lZXRpbmdFeGNlcHRpb25UeXBlLCBKb2luTWVldGluZ1Jlc3BvbnNlLCBNZWV0aW5nSW5mbywgTWV0YWRhdGEgfSBmcm9tIFwiLi9jb25zdFwiO1xuaW1wb3J0IHsgZ2V0RXhwaXJlRGF0ZSB9IGZyb20gXCIuL3V0aWxcIjtcbnZhciBtZWV0aW5nVGFibGVOYW1lID0gcHJvY2Vzcy5lbnYuTUVFVElOR19UQUJMRV9OQU1FITtcbnZhciBhdHRlbmRlZXNUYWJsZU5hbWUgPSBwcm9jZXNzLmVudi5BVFRFTkRFRV9UQUJMRV9OQU1FITtcbnZhciBkZGIgPSBuZXcgRHluYW1vREIoKTtcbmNvbnN0IGNoaW1lID0gbmV3IENoaW1lKHsgcmVnaW9uOiBcInVzLWVhc3QtMVwiIH0pO1xuY2hpbWUuZW5kcG9pbnQgPSBuZXcgRW5kcG9pbnQoXCJodHRwczovL3NlcnZpY2UuY2hpbWUuYXdzLmFtYXpvbi5jb20vY29uc29sZVwiKTtcbi8qKlxuICogZ2V0IG1lZXRpbmcgaW5mb1xuICogKDEpIHJldHJpZXZlIG1lZXRpbmcgaW5mbyBmcm9tIERCXG4gKiAoMikgSWYgdGhlcmUgaXMgbm8gbWVldGluZyBpbiBEQiwgcmV0dXJuIG51bGxcbiAqICgzKSBJZiB0aGVyZSBpcyBubyBtZWV0aW5nIGluIEFtYXpvbiBDaGltZSwgZGVsZXRlIGZyb20gREIgYW5kIHJldHVybiBudWxsLlxuICogQHBhcmFtIHsqfSBtZWV0aW5nTmFtZVxuICovXG5leHBvcnQgY29uc3QgZ2V0TWVldGluZ0luZm8gPSBhc3luYyAobWVldGluZ05hbWU6IHN0cmluZyk6IFByb21pc2U8TWVldGluZ0luZm8gfCBudWxsPiA9PiB7XG4gICAgLy8vLyAoMSkgcmV0cmlldmUgaW5mb1xuICAgIGNvbnNvbGUubG9nKFwiZHluYW1vMVwiLCBtZWV0aW5nTmFtZSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGRiLmdldEl0ZW0oeyBUYWJsZU5hbWU6IG1lZXRpbmdUYWJsZU5hbWUsIEtleTogeyBNZWV0aW5nTmFtZTogeyBTOiBtZWV0aW5nTmFtZSB9IH0gfSkucHJvbWlzZSgpO1xuICAgIGNvbnNvbGUubG9nKFwiZHluYW1vMlwiLCByZXN1bHQpO1xuXG4gICAgLy8vLyAoMikgSWYgbm8gbWVldGluZyBpbiBEQiwgcmV0dXJuIG51bGxcbiAgICBpZiAoIXJlc3VsdC5JdGVtKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIC8vLy8gKDMpIElmIG5vIG1lZXRpbmcgaW4gQ2hpbWUsIGRlbGV0ZSBtZWV0aW5nIGZyb20gREIgYW5kIHJldHVybiBudWxsXG4gICAgY29uc3QgbWVldGluZ0luZm8gPSByZXN1bHQuSXRlbSE7XG4gICAgY29uc29sZS5sb2coXCJSRUFEIFBST1BSMVwiKTtcbiAgICBjb25zdCBtZWV0aW5nRGF0YSA9IEpTT04ucGFyc2UobWVldGluZ0luZm8uTWVldGluZy5TISk7XG4gICAgY29uc29sZS5sb2coXCJSRUFEIFBST1BSMlwiKTtcbiAgICB0cnkge1xuICAgICAgICAvLyBDaGVjayBFeGlzdD9cbiAgICAgICAgY29uc3QgbWlkID0gYXdhaXQgY2hpbWUuZ2V0TWVldGluZyh7IE1lZXRpbmdJZDogbWVldGluZ0RhdGEuTWVldGluZ0lkIH0pLnByb21pc2UoKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJjaGltZSBtZWV0aW5nIGluZm86XCIsIG1pZCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2hpbWUgbWVldGluZyBleGNlcHRpb246XCIsIGVycik7XG4gICAgICAgIGF3YWl0IGRlbGV0ZU1lZXRpbmcobWVldGluZ05hbWUpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc29sZS5sb2coXCJSRUFEIFBST1BSM1wiKTtcblxuICAgIC8vLy8gKDQpIHJldHVybiBtZWV0aW5nIGluZm9cbiAgICByZXR1cm4ge1xuICAgICAgICBtZWV0aW5nTmFtZTogbWVldGluZ0luZm8uTWVldGluZ05hbWUuUyEsXG4gICAgICAgIG1lZXRpbmdJZDogbWVldGluZ0luZm8uTWVldGluZ0lkLlMhLFxuICAgICAgICBtZWV0aW5nOiBKU09OLnBhcnNlKG1lZXRpbmdJbmZvLk1lZXRpbmcuUyEpLFxuICAgICAgICBtZXRhZGF0YTogSlNPTi5wYXJzZShtZWV0aW5nSW5mby5NZXRhZGF0YS5TISksXG4gICAgICAgIGhtbVRhc2tBcm46IG1lZXRpbmdJbmZvLkhtbVRhc2tBcm4gPyBtZWV0aW5nSW5mby5IbW1UYXNrQXJuLlMhIDogXCItXCIsXG4gICAgfTtcbn07XG5cbi8qKlxuICogRGVsZXRlIG1lZXRpbmcgZnJvbSBEQlxuICogQHBhcmFtIHsqfSBtZWV0aW5nTmFtZVxuICovXG5leHBvcnQgY29uc3QgZGVsZXRlTWVldGluZyA9IGFzeW5jIChtZWV0aW5nTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgYXdhaXQgZGRiXG4gICAgICAgIC5kZWxldGVJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogbWVldGluZ1RhYmxlTmFtZSxcbiAgICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgICAgIE1lZXRpbmdOYW1lOiB7IFM6IG1lZXRpbmdOYW1lIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgICAgICAucHJvbWlzZSgpO1xufTtcblxuZXhwb3J0IGNvbnN0IGNyZWF0ZU1lZXRpbmcgPSBhc3luYyAoZW1haWw6IHN0cmluZywgbWVldGluZ05hbWU6IHN0cmluZywgcmVnaW9uOiBzdHJpbmcpOiBQcm9taXNlPENyZWF0ZU1lZXRpbmdSZXNwb25zZT4gPT4ge1xuICAgIC8vLy8gKDEpIGNoZWNrIG1lZXRpbmcgbmFtZSBleGlzdFxuICAgIGNvbnN0IG1lZXRpbmdJbmZvID0gYXdhaXQgZ2V0TWVldGluZ0luZm8obWVldGluZ05hbWUpO1xuICAgIGlmIChtZWV0aW5nSW5mbyAhPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY3JlYXRlZDogZmFsc2UsXG4gICAgICAgICAgICBtZWV0aW5nSWQ6IG1lZXRpbmdJbmZvLm1lZXRpbmdJZCxcbiAgICAgICAgICAgIG1lZXRpbmdOYW1lOiBtZWV0aW5nSW5mby5tZWV0aW5nTmFtZSxcbiAgICAgICAgICAgIG93bmVySWQ6IG1lZXRpbmdJbmZvLm1ldGFkYXRhLk93bmVySWQsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8vLyAoMikgY3JlYXRlIG1lZXRpbmcgaW4gQW1hem9uIENoaW1lXG4gICAgY29uc3QgcmVxdWVzdDogQ2hpbWUuQ3JlYXRlTWVldGluZ1JlcXVlc3QgPSB7XG4gICAgICAgIENsaWVudFJlcXVlc3RUb2tlbjogdjQoKSxcbiAgICAgICAgTWVkaWFSZWdpb246IHJlZ2lvbixcbiAgICB9O1xuICAgIGNvbnN0IG5ld01lZXRpbmdJbmZvID0gYXdhaXQgY2hpbWUuY3JlYXRlTWVldGluZyhyZXF1ZXN0KS5wcm9taXNlKCk7XG5cbiAgICAvLy8vICgzKSByZWdpc3RlciBtZWV0aW5nIGluZm8gaW4gREJcbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoKTtcbiAgICBjb25zdCBub3cgPSBkYXRlLmdldFRpbWUoKTtcbiAgICBjb25zdCBtZXRhZGF0YTogTWV0YWRhdGEgPSB7XG4gICAgICAgIE93bmVySWQ6IGVtYWlsLFxuICAgICAgICBSZWdpb246IHJlZ2lvbixcbiAgICAgICAgU3RhcnRUaW1lOiBub3csXG4gICAgfTtcbiAgICBjb25zdCBpdGVtID0ge1xuICAgICAgICBNZWV0aW5nTmFtZTogeyBTOiBtZWV0aW5nTmFtZSB9LFxuICAgICAgICBNZWV0aW5nSWQ6IHsgUzogbmV3TWVldGluZ0luZm8uTWVldGluZyEuTWVldGluZ0lkIH0sXG4gICAgICAgIE1lZXRpbmc6IHsgUzogSlNPTi5zdHJpbmdpZnkobmV3TWVldGluZ0luZm8uTWVldGluZykgfSxcbiAgICAgICAgTWV0YWRhdGE6IHsgUzogSlNPTi5zdHJpbmdpZnkobWV0YWRhdGEpIH0sXG4gICAgICAgIFRUTDoge1xuICAgICAgICAgICAgTjogXCJcIiArIGdldEV4cGlyZURhdGUoKSxcbiAgICAgICAgfSxcbiAgICB9O1xuICAgIGF3YWl0IGRkYlxuICAgICAgICAucHV0SXRlbSh7XG4gICAgICAgICAgICBUYWJsZU5hbWU6IG1lZXRpbmdUYWJsZU5hbWUsXG4gICAgICAgICAgICBJdGVtOiBpdGVtLFxuICAgICAgICB9KVxuICAgICAgICAucHJvbWlzZSgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgY3JlYXRlZDogdHJ1ZSxcbiAgICAgICAgbWVldGluZ0lkOiBuZXdNZWV0aW5nSW5mby5NZWV0aW5nIS5NZWV0aW5nSWQhLFxuICAgICAgICBtZWV0aW5nTmFtZTogbWVldGluZ05hbWUsXG4gICAgICAgIG93bmVySWQ6IGVtYWlsLFxuICAgIH07XG59O1xuXG5leHBvcnQgY29uc3Qgam9pbk1lZXRpbmcgPSBhc3luYyAobWVldGluZ05hbWU6IHN0cmluZywgYXR0ZW5kZWVOYW1lOiBzdHJpbmcpOiBQcm9taXNlPEpvaW5NZWV0aW5nUmVzcG9uc2UgfCBKb2luTWVldGluZ0V4Y2VwdGlvbj4gPT4ge1xuICAgIC8vLy8gKDEpIGNoZWNrIG1lZXRpbmcgZXhpc3RzXG4gICAgbGV0IG1lZXRpbmdJbmZvID0gYXdhaXQgZ2V0TWVldGluZ0luZm8obWVldGluZ05hbWUpO1xuICAgIGlmIChtZWV0aW5nSW5mbyA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29kZTogSm9pbk1lZXRpbmdFeGNlcHRpb25UeXBlLk5PX01FRVRJTkdfRk9VTkQsXG4gICAgICAgICAgICBleGNlcHRpb246IHRydWUsXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLy8vLyAoMikgY2hlY2sgYXR0ZW5kZWVOYW1lXG4gICAgaWYgKGF0dGVuZGVlTmFtZSA9PT0gXCJcIikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29kZTogSm9pbk1lZXRpbmdFeGNlcHRpb25UeXBlLlBBUkFNRVRFUl9FUlJPUixcbiAgICAgICAgICAgIGV4Y2VwdGlvbjogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvLy8vICgzKSBjcmVhdGUgYXR0ZW5kZWUgaW4gQW1hem9uIENoaW1lXG4gICAgY29uc29sZS5pbmZvKFwiQWRkaW5nIG5ldyBhdHRlbmRlZVwiKTtcbiAgICBjb25zdCBhdHRlbmRlZUluZm8gPSBhd2FpdCBjaGltZVxuICAgICAgICAuY3JlYXRlQXR0ZW5kZWUoe1xuICAgICAgICAgICAgTWVldGluZ0lkOiBtZWV0aW5nSW5mby5tZWV0aW5nSWQsXG4gICAgICAgICAgICBFeHRlcm5hbFVzZXJJZDogdjQoKSxcbiAgICAgICAgfSlcbiAgICAgICAgLnByb21pc2UoKTtcblxuICAgIC8vLy8gKDQpIHJlZ2lzdGVyIGF0dGVuZGVlIGluIERCXG4gICAgYXdhaXQgZGRiXG4gICAgICAgIC5wdXRJdGVtKHtcbiAgICAgICAgICAgIFRhYmxlTmFtZTogYXR0ZW5kZWVzVGFibGVOYW1lLFxuICAgICAgICAgICAgSXRlbToge1xuICAgICAgICAgICAgICAgIEF0dGVuZGVlSWQ6IHtcbiAgICAgICAgICAgICAgICAgICAgUzogYCR7bWVldGluZ05hbWV9LyR7YXR0ZW5kZWVJbmZvLkF0dGVuZGVlIS5BdHRlbmRlZUlkfWAsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBBdHRlbmRlZU5hbWU6IHsgUzogYXR0ZW5kZWVOYW1lIH0sXG4gICAgICAgICAgICAgICAgVFRMOiB7XG4gICAgICAgICAgICAgICAgICAgIE46IFwiXCIgKyBnZXRFeHBpcmVEYXRlKCksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgICAgIC5wcm9taXNlKCk7XG5cbiAgICBjb25zb2xlLmxvZyhcIk1FRVRJTkdfSU5GT1wiLCBtZWV0aW5nSW5mbyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBtZWV0aW5nTmFtZTogbWVldGluZ0luZm8ubWVldGluZ05hbWUsXG4gICAgICAgIG1lZXRpbmc6IG1lZXRpbmdJbmZvLm1lZXRpbmcsXG4gICAgICAgIGF0dGVuZGVlOiBhdHRlbmRlZUluZm8uQXR0ZW5kZWUhLFxuICAgIH07XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0QXR0ZW5kZWVJbmZvID0gYXN5bmMgKG1lZXRpbmdOYW1lOiBzdHJpbmcsIGF0dGVuZGVlSWQ6IHN0cmluZyk6IFByb21pc2U8R2V0QXR0ZW5kZWVJbmZvUmVzcG9uc2UgfCBHZXRBdHRlbmRlZUluZm9FeGNlcHRpb24+ID0+IHtcbiAgICAvLy8vICgxKSByZXRyaWV2ZSBhdHRlbmRlZSBpbmZvIGZyb20gREIuIGtleSBpcyBjb25jYXRpbmF0ZSBvZiBtZWV0aW5nTmFtZShlbmNvZGVkKSBhbmQgYXR0ZW5kZWVJZFxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRkYlxuICAgICAgICAuZ2V0SXRlbSh7XG4gICAgICAgICAgICBUYWJsZU5hbWU6IGF0dGVuZGVlc1RhYmxlTmFtZSxcbiAgICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgICAgIEF0dGVuZGVlSWQ6IHtcbiAgICAgICAgICAgICAgICAgICAgUzogYCR7bWVldGluZ05hbWV9LyR7YXR0ZW5kZWVJZH1gLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9LFxuICAgICAgICB9KVxuICAgICAgICAucHJvbWlzZSgpO1xuXG4gICAgLy8vLyAoMikgSWYgdGhlcmUgaXMgbm8gYXR0ZW5kZWUgaW4gdGhlIG1lZXRpbmcsIHJldHVybiBmYWlsXG4gICAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgY29kZTogR2V0QXR0ZW5kZWVJbmZvRXhjZXB0aW9uVHlwZS5OT19BVFRFTkRFRV9GT1VORCxcbiAgICAgICAgICAgIGV4Y2VwdGlvbjogdHJ1ZSxcbiAgICAgICAgfTtcbiAgICB9XG4gICAgY29uc29sZS5sb2cocmVzdWx0KTtcblxuICAgIC8vLy8gKDMpIHJldHVybiBhdHRlbmRlZSBpbmZvLlxuICAgIHJldHVybiB7XG4gICAgICAgIGF0dGVuZGVlSWQ6IHJlc3VsdC5JdGVtLkF0dGVuZGVlSWQuUyEsXG4gICAgICAgIGF0dGVuZGVlTmFtZTogcmVzdWx0Lkl0ZW0uQXR0ZW5kZWVOYW1lLlMhLFxuICAgIH07XG59O1xuIl19